<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nest.js学习（二） | 凌烟</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="https://fang-kang.gitee.io/blog-img/favicon.ico">
    <meta name="description" content="stay true to the mission.">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.c0543776.css" as="style"><link rel="preload" href="/assets/js/app.4aa0e8ea.js" as="script"><link rel="preload" href="/assets/js/4.3a6b897f.js" as="script"><link rel="preload" href="/assets/js/1.97f2804a.js" as="script"><link rel="preload" href="/assets/js/2.13201674.js" as="script"><link rel="preload" href="/assets/js/42.5ae1c9f5.js" as="script"><link rel="prefetch" href="/assets/js/10.956d5498.js"><link rel="prefetch" href="/assets/js/11.251f530d.js"><link rel="prefetch" href="/assets/js/12.d01bf345.js"><link rel="prefetch" href="/assets/js/13.bb070dff.js"><link rel="prefetch" href="/assets/js/14.b543585c.js"><link rel="prefetch" href="/assets/js/15.b1bcf849.js"><link rel="prefetch" href="/assets/js/16.43b94681.js"><link rel="prefetch" href="/assets/js/17.aa1e97c6.js"><link rel="prefetch" href="/assets/js/18.aa235895.js"><link rel="prefetch" href="/assets/js/19.10a3cdf0.js"><link rel="prefetch" href="/assets/js/20.a125aaa0.js"><link rel="prefetch" href="/assets/js/21.9e6ce220.js"><link rel="prefetch" href="/assets/js/22.9b80c541.js"><link rel="prefetch" href="/assets/js/23.0e9e503f.js"><link rel="prefetch" href="/assets/js/24.fcded96a.js"><link rel="prefetch" href="/assets/js/25.6a74bbbd.js"><link rel="prefetch" href="/assets/js/26.92b3b14a.js"><link rel="prefetch" href="/assets/js/27.18fb41d5.js"><link rel="prefetch" href="/assets/js/28.1d8217aa.js"><link rel="prefetch" href="/assets/js/29.910249cb.js"><link rel="prefetch" href="/assets/js/30.7ffd4cf7.js"><link rel="prefetch" href="/assets/js/31.e5afbb5b.js"><link rel="prefetch" href="/assets/js/32.796285aa.js"><link rel="prefetch" href="/assets/js/33.4042bf41.js"><link rel="prefetch" href="/assets/js/34.b887e798.js"><link rel="prefetch" href="/assets/js/35.cf4833c1.js"><link rel="prefetch" href="/assets/js/36.1d919a3c.js"><link rel="prefetch" href="/assets/js/37.4c63b466.js"><link rel="prefetch" href="/assets/js/38.4f2abbf2.js"><link rel="prefetch" href="/assets/js/39.663ea2e3.js"><link rel="prefetch" href="/assets/js/40.99d7fef1.js"><link rel="prefetch" href="/assets/js/41.24ea1bda.js"><link rel="prefetch" href="/assets/js/43.61430462.js"><link rel="prefetch" href="/assets/js/44.95389ae8.js"><link rel="prefetch" href="/assets/js/45.e94972fb.js"><link rel="prefetch" href="/assets/js/46.4abcad03.js"><link rel="prefetch" href="/assets/js/47.5022029f.js"><link rel="prefetch" href="/assets/js/48.15206369.js"><link rel="prefetch" href="/assets/js/49.54505c66.js"><link rel="prefetch" href="/assets/js/5.32ec8265.js"><link rel="prefetch" href="/assets/js/50.cdc116d4.js"><link rel="prefetch" href="/assets/js/51.e6b2bae7.js"><link rel="prefetch" href="/assets/js/52.88cfc911.js"><link rel="prefetch" href="/assets/js/53.ea97ed47.js"><link rel="prefetch" href="/assets/js/54.636e88d0.js"><link rel="prefetch" href="/assets/js/55.ad5ebf00.js"><link rel="prefetch" href="/assets/js/56.68db72c1.js"><link rel="prefetch" href="/assets/js/57.e92d20ec.js"><link rel="prefetch" href="/assets/js/58.f1a79bf1.js"><link rel="prefetch" href="/assets/js/59.80f3636b.js"><link rel="prefetch" href="/assets/js/6.22876f96.js"><link rel="prefetch" href="/assets/js/60.5676553a.js"><link rel="prefetch" href="/assets/js/61.823d8bbc.js"><link rel="prefetch" href="/assets/js/62.3ea4862d.js"><link rel="prefetch" href="/assets/js/63.1db0a1d6.js"><link rel="prefetch" href="/assets/js/64.5808862e.js"><link rel="prefetch" href="/assets/js/65.9539285b.js"><link rel="prefetch" href="/assets/js/66.a50ff9e7.js"><link rel="prefetch" href="/assets/js/67.03936b73.js"><link rel="prefetch" href="/assets/js/68.3cbbbf1e.js"><link rel="prefetch" href="/assets/js/69.54b2e54e.js"><link rel="prefetch" href="/assets/js/7.06eda39e.js"><link rel="prefetch" href="/assets/js/8.d5a33fd8.js"><link rel="prefetch" href="/assets/js/9.0c4df056.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c0543776.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-04b97590><div data-v-04b97590><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-04b97590 data-v-04b97590><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-2a121430 data-v-04b97590 data-v-04b97590><h3 class="title" style="display:none;" data-v-2a121430 data-v-2a121430>凌烟</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-2a121430 data-v-2a121430><input type="password" value="" data-v-2a121430> <span data-v-2a121430>Konck! Knock!</span> <button data-v-2a121430>OK</button></label> <div class="footer" style="display:none;" data-v-2a121430 data-v-2a121430><span data-v-2a121430><i class="iconfont reco-theme" data-v-2a121430></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-2a121430>vuePress-theme-reco</a></span> <span data-v-2a121430><i class="iconfont reco-copyright" data-v-2a121430></i> <a data-v-2a121430><span data-v-2a121430>Fk</span>
            
          <span data-v-2a121430>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-04b97590><header class="navbar" data-v-04b97590><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://fang-kang.gitee.io/blog-img/head.jpg" alt="凌烟" class="logo"> <span class="site-name">凌烟</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Js/" class="nav-link"><i></i>
  Js
</a></li><li class="dropdown-item"><!----> <a href="/categories/node/" class="nav-link"><i></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/categories/mongodb/" class="nav-link"><i></i>
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/categories/其他/" class="nav-link"><i></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/uniApp/" class="nav-link"><i></i>
  uniApp
</a></li><li class="dropdown-item"><!----> <a href="/categories/vue/" class="nav-link"><i></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/categories/webpack/" class="nav-link"><i></i>
  webpack
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/views/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      学习手册
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/es6" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  Es6
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/ts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  TypeScript
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/vue3.0" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  Vue3.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/node" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  Node
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fang-kang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/fang-kang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-04b97590></div> <aside class="sidebar" data-v-04b97590><div class="personal-info-wrapper" data-v-5641b559 data-v-04b97590><img src="https://fang-kang.gitee.io/blog-img/head.jpg" alt="author-avatar" class="personal-img" data-v-5641b559> <h3 class="name" data-v-5641b559>
    Fk
  </h3> <div class="num" data-v-5641b559><div data-v-5641b559><h3 data-v-5641b559>47</h3> <h6 data-v-5641b559>Article</h6></div> <div data-v-5641b559><h3 data-v-5641b559>19</h3> <h6 data-v-5641b559>Tag</h6></div></div> <hr data-v-5641b559></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Js/" class="nav-link"><i></i>
  Js
</a></li><li class="dropdown-item"><!----> <a href="/categories/node/" class="nav-link"><i></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/categories/mongodb/" class="nav-link"><i></i>
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/categories/其他/" class="nav-link"><i></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/uniApp/" class="nav-link"><i></i>
  uniApp
</a></li><li class="dropdown-item"><!----> <a href="/categories/vue/" class="nav-link"><i></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/categories/webpack/" class="nav-link"><i></i>
  webpack
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/views/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      学习手册
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/es6" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  Es6
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/ts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  TypeScript
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/vue3.0" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  Vue3.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fang-kang.gitee.io/node" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  Node
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fang-kang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/fang-kang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-2a121430 data-v-04b97590><h3 class="title" style="display:none;" data-v-2a121430 data-v-2a121430>nest.js学习（二）</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-2a121430 data-v-2a121430><input type="password" value="" data-v-2a121430> <span data-v-2a121430>Konck! Knock!</span> <button data-v-2a121430>OK</button></label> <div class="footer" style="display:none;" data-v-2a121430 data-v-2a121430><span data-v-2a121430><i class="iconfont reco-theme" data-v-2a121430></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-2a121430>vuePress-theme-reco</a></span> <span data-v-2a121430><i class="iconfont reco-copyright" data-v-2a121430></i> <a data-v-2a121430><span data-v-2a121430>Fk</span>
            
          <span data-v-2a121430>2020 - </span>
          2021
        </a></span></div></div> <div data-v-04b97590><main class="page"><div class="page-title" style="display:none;"><h1 class="title">nest.js学习（二）</h1> <div data-v-d683b3c2><i class="iconfont reco-account" data-v-d683b3c2><span data-v-d683b3c2>Fk</span></i> <i class="iconfont reco-date" data-v-d683b3c2><span data-v-d683b3c2>2021-01-29 18:02:00</span></i> <i class="iconfont reco-eye" data-v-d683b3c2><span id="/views/node/nest_2.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-d683b3c2><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-d683b3c2><span class="tag-item" data-v-d683b3c2>node</span><span class="tag-item" data-v-d683b3c2>nest</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><p>这篇主要内容：</p> <ul><li>项目架构规划</li> <li>入口文件配置说明</li> <li>依赖安装</li> <li>配置模板引擎和静态文件</li> <li>静态模板</li> <li>系统配置和应用配置</li> <li>数据库之用户表</li> <li>注册</li> <li>使用node-mailer发送邮件</li> <li>登录和第三方认证github登录</li> <li>session和cookie</li> <li>找回密码和登出</li></ul> <h2 id="项目架构规划设计"><a href="#项目架构规划设计" class="header-anchor">#</a> 项目架构规划设计</h2> <p>一个好的文件结构约定，会让我们开发合作、维护管理，节省很多不必要沟通。</p> <p>这里我<code>src</code>文件规划：</p> <table><thead><tr><th>文件</th> <th>说明</th></tr></thead> <tbody><tr><td>main.ts</td> <td>入口</td></tr> <tr><td>main.hmr.ts</td> <td>热更新入口</td></tr> <tr><td>app.service.ts</td> <td>APP服务（选择）</td></tr> <tr><td>app.module.ts</td> <td>APP模块（根模块，必须）</td></tr> <tr><td>app.controller.ts</td> <td>APP控制器（选择）</td></tr> <tr><td>app.controller.spec.ts</td> <td>APP控制器单元测试用例（选择）</td></tr> <tr><td>config</td> <td>配置模块</td></tr> <tr><td>core</td> <td>核心模块（申明过滤器、管道、拦截器、守卫、中间件、全局模块）</td></tr> <tr><td>feature</td> <td>特性模块（主要业务模块）</td></tr> <tr><td>shared</td> <td>共享模块（共享mongodb、redis封装服务、通用服务）</td></tr> <tr><td>tools</td> <td>工具（提供一些小工具函数）</td></tr></tbody></table> <blockquote><p>这是我参考我<code>Angular</code>项目的结构，写了几个<code>nest</code>项目后发现这个很不错。把<code>mongodb</code>服务和业务模块分开，还有一个好处就是减少<code>nest</code>循环依赖注入深坑，后面会讲怎么解决它。</p></blockquote> <h2 id="入口文件配置说明"><a href="#入口文件配置说明" class="header-anchor">#</a> 入口文件配置说明</h2> <p>打开<code>main.ts</code>文件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>NestFactory</code> 创建一个app实例，监听<code>3000</code>端口。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * Creates an instance of the NestApplication
 * @returns {Promise}
 */</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>INestApplication <span class="token operator">&amp;</span> INestExpressApplication<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> options<span class="token operator">:</span> NestApplicationOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>INestApplication <span class="token operator">&amp;</span> INestExpressApplication<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> httpServer<span class="token operator">:</span> FastifyAdapter<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> NestApplicationOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>INestApplication <span class="token operator">&amp;</span> INestFastifyApplication<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> httpServer<span class="token operator">:</span> HttpServer<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> NestApplicationOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>INestApplication <span class="token operator">&amp;</span> INestExpressApplication<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> httpServer<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> NestApplicationOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>INestApplication <span class="token operator">&amp;</span> INestExpressApplication<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p><code>create</code>方法有1-3参数，第一个是入口模块<code>AppModule</code>, 第二个是一个<code>httpServer</code>,如果要绑定<code>Express</code>中间件，需要传递<code>Express</code>实例。第三个全局配置：</p> <ul><li>logger 打印日志</li> <li>cors 跨域配置</li> <li>bodyParser post和put解析body中间件配置</li> <li>httpsOptions https配置</li></ul> <p><code>app</code> 带方法有哪些
<code>INestApplication</code>下</p> <ul><li>init 初始化应用程序，直接调用此方法并非强制。（效果不明）</li> <li>use 注册中间件</li> <li>enableCors 启用CORS（跨源资源共享）</li> <li>listen 启动应用程序。</li> <li>listenAsync 同步启动应用程序。</li> <li>setGlobalPrefix 注册每个HTTP路由路径的前缀</li> <li>useWebSocketAdapter 安装将在网关内部使用的Ws适配器。使用时覆盖，默认<code>socket.io</code>库。</li> <li>connectMicroservice 将微服务连接到NestApplication实例。 将应用程序转换为混合实例。</li> <li>getMicroservices 返回连接到NestApplication的微服务的数组。</li> <li>getHttpServer 返回基础的本地HTTP服务器。</li> <li>startAllMicroservices 异步启动所有连接的微服务</li> <li>startAllMicroservicesAsync 同步启动所有连接的微服务</li> <li>useGlobalFilters 将异常过滤器注册为全局过滤器（将在每个HTTP路由处理程序中使用）</li> <li>useGlobalPipes 将管道注册为全局管道（将在每个HTTP路由处理程序中使用）</li> <li>useGlobalInterceptors 将拦截器注册为全局拦截器（将在每个HTTP路由处理器中使用）</li> <li>useGlobalGuards 注册警卫作为全局警卫（将在每个HTTP路由处理程序中使用）</li> <li>close 终止应用程序（包括NestApplication，网关和每个连接的微服务）
<code>INestExpressApplication</code>下</li> <li>set 围绕本地<code>express.set()</code>方法的包装函数。</li> <li>engine 围绕本地<code>express.engine()</code>方法的包装函数。</li> <li>enable 围绕本地<code>express.enable()</code>方法的包装函数。</li> <li>disable 围绕本地<code>express.disable()</code>方法的包装函数。</li> <li>useStaticAssets 为静态资源设置基础目录。围绕本地<code>express.static(path, options)</code>方法的包装函数。</li> <li>setBaseViewsDir 设置模板（视图）的基本目录。围绕本地<code>express.set('views', path)</code>方法的包装函数。</li> <li>setViewEngine 为模板（视图）设置视图引擎。围绕本地<code>express.set('view engine', engine)</code>方法的包装函数。</li></ul> <h2 id="依赖安装"><a href="#依赖安装" class="header-anchor">#</a> 依赖安装</h2> <h3 id="核心依赖"><a href="#核心依赖" class="header-anchor">#</a> 核心依赖</h3> <p>因为目前CNode采用<code>Egg</code>编写，里面大量使用与<code>Egg</code>集成的<code>egg-xxx</code>包，这里我把相关的连对应的依赖都一一来出来。</p> <h4 id="模板引擎"><a href="#模板引擎" class="header-anchor">#</a> 模板引擎</h4> <p><code>Egg-CNode</code>使用<code>egg-view-ejs</code>，本项目使用<code>ejs</code>包，唯一缺点没有<code>layout</code>功能，可以麻烦点，在每个文件引入头和尾即可，也有另外一个包<code>ejs-mate</code>，它有<code>layout</code>功能，后面会介绍它怎么使用。</p> <h4 id="redis"><a href="#redis" class="header-anchor">#</a> redis</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>Egg-CNode<span class="token variable"><span class="token variable">`</span>使用<span class="token variable">`</span></span>egg-redis<span class="token variable"><span class="token variable">`</span>操作<span class="token variable">`</span></span>redis<span class="token variable"><span class="token variable">`</span>，其实它是包装的<span class="token variable">`</span></span>ioredis<span class="token variable"><span class="token variable">`</span>包，我也一直在nodejs里使用这个包，需要安装生产<span class="token variable">`</span></span>ioredis<span class="token variable"><span class="token variable">`</span>和开发<span class="token variable">`</span></span>@types/ioredis
</code></pre></div><h4 id="mongoose"><a href="#mongoose" class="header-anchor">#</a> mongoose</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>Egg-CNode<span class="token variable"><span class="token variable">`</span>使用<span class="token variable">`</span></span>egg-mongoose<span class="token variable"><span class="token variable">`</span>操作<span class="token variable">`</span></span>mongodb<span class="token variable"><span class="token variable">`</span>，<span class="token variable">`</span></span>Nest<span class="token variable"><span class="token variable">`</span>提供了<span class="token variable">`</span></span>@nestjs/mongoose<span class="token variable"><span class="token variable">`</span>，需要安装生产<span class="token variable">`</span></span>mongoose<span class="token variable"><span class="token variable">`</span>和开发<span class="token variable">`</span></span>@types/mongoose
</code></pre></div><h4 id="passport"><a href="#passport" class="header-anchor">#</a> passport</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>Egg-CNode<span class="token variable"><span class="token variable">`</span>使用<span class="token variable">`</span></span>egg-passport、egg-passport-github、egg-passport-local<span class="token variable"><span class="token variable">`</span>做身份验证，<span class="token variable">`</span></span>Nest<span class="token variable"><span class="token variable">`</span>提供了<span class="token variable">`</span></span>@nestjs/passport<span class="token variable"><span class="token variable">`</span>，需要安装生产<span class="token variable">`</span></span>passport、passport-github、passport-local
</code></pre></div><p>其他依赖在后面用到时候在详细介绍，这几个是比较重要的依赖。</p> <h2 id="配置-views-视图模板和-public-静态资源"><a href="#配置-views-视图模板和-public-静态资源" class="header-anchor">#</a> 配置 Views 视图模板和 public 静态资源</h2> <p><code>CNode</code> 使用的是<code>egg-ejs</code>,为了简单点，减少静态文件编写，我也用<code>ejs</code>。发现区别就是少了<code>layout</code>功能，需要我们拆分<code>layout/header.ejs</code>和<code>layout/footer.ejs</code>在使用了。
但是有一个包可以做到类似的功能<code>ejs-mate</code>，这个是<a href="https://github.com/JacksonTian" target="_blank" rel="noopener noreferrer">@JacksonTian<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 朴灵大神的作品。</p> <p>新建模板存放<code>views</code>文件夹(root/views)和静态资源存放<code>public</code>文件夹(root/public)</p> <p><strong>注意</strong>：<code>nest-cli</code>默认只处理<code>src</code>里面的ts文件，如有其他文件需要自己写脚本处理，<code>gulp</code>或者<code>webpack</code>都可以，这里就简单一点，直接把<code>views</code>和<code>public</code>放在<code>src</code>平级的根目录里面了。后面会说怎么处理它们设置问题。</p> <h3 id="模板引擎-2"><a href="#模板引擎-2" class="header-anchor">#</a> 模板引擎</h3> <p>安装<code>ejs-mate</code>依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> ejs-mate --save
</code></pre></div><p>用法很简单了，关于文件名后缀，默认使用<code>.ejs</code>，<code>.ejs</code>虽然会让它语法高亮，有个坑就<code>html</code>标签不会自动补全提示。那需要换成<code>.html</code>后缀。</p> <p>设置模板引擎：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ejsMate <span class="token keyword">from</span> <span class="token string">'ejs-mate'</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
      <span class="token comment">// 获取根目录 nest-cnode</span>
    <span class="token keyword">const</span> rootDir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 指定视图引擎 处理.html后缀文件</span>
    app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span> ejsMate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 视图引擎</span>
    app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置模板（视图）的基本目录</span>
    app<span class="token punctuation">.</span><span class="token function">setBaseViewsDir</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意</strong>：当前启动程序是<code>src/main.ts</code>，因为<code>views</code>和<code>public</code>在根目录，所有我们就需要去获取获取根目录。其他注释已经说明，就不再赘述。</p></blockquote> <p>使用模板引擎：</p> <ol><li>我们在<code>views</code>文件夹里面新建一个<code>layout.html</code>和一个<code>index.html</code>。</li> <li>写通用的<code>layout.html</code></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh-CN<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>我是layout模板<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    &lt;%- body -%&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol><li>写的<code>index.html</code></li></ol> <div class="language-html extra-class"><pre class="language-html"><code>&lt;% layout('layout') -%&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>我是首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>  
</code></pre></div><ol><li>渲染模板引擎</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Get<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> appService<span class="token operator">:</span> AppService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span>
  <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注意</strong>：<code>@Render()</code>里面一定要写模板文件名(可以省略后缀)，不然访问页面显示是<code>json</code>对象。</p> <p>访问首页<code>http://localhost:3000/</code>看结果。</p> <p><a href="https://user-images.githubusercontent.com/6111778/44764383-043ced00-ab82-11e8-8ae4-35d9cedcd26d.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/44764383-043ced00-ab82-11e8-8ae4-35d9cedcd26d.png" alt="3nc4l2 l_nbp_di0fkomamc"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>ejs-mate</code>语法：</p> <p><code>ejs-mate</code>兼容<a href="https://ejs.bootcss.com/" target="_blank" rel="noopener noreferrer">ejs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>语法，语法很简单，这里顺便带一下：</p> <ul><li>&lt;% '脚本' 标签，用于流程控制，无输出。</li> <li>&lt;%_ 删除其前面的空格符</li> <li>&lt;%= 输出数据到模板（输出是转义 HTML 标签）</li> <li>&lt;%- 输出非转义的数据到模板</li> <li>&lt;%# 注释标签，不执行、不输出内容</li> <li>&lt;%% 输出字符串 '&lt;%'</li> <li>%&gt; 一般结束标签</li> <li>-%&gt; 删除紧随其后的换行符</li> <li>_%&gt; 将结束标签后面的空格符删除</li></ul> <p>说几个常用的写法：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span>% 直接写js代码，不输出：%<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>% users.forEach<span class="token punctuation">(</span>function<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span> %<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>%- include<span class="token punctuation">(</span><span class="token string">'user/show'</span>, <span class="token punctuation">{</span>user: user<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> %<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>% <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> %<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/ul<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>%<span class="token comment"># 输出变量：%&gt;</span>

<span class="token operator">&lt;</span>%<span class="token operator">=</span> <span class="token string">'变量'</span> %<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>%<span class="token comment"># 输出HTML：%&gt;</span>

<span class="token operator">&lt;</span>%- <span class="token string">'&lt;h1&gt;标题&lt;/h1&gt;'</span> %<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>%<span class="token comment"># 引入其他ejs文件（注意：2个参数，第一个是路径：相对于当前模板路径中的模板片段包含进来；第二个是传递数据对象。）：%&gt;</span>

<span class="token operator">&lt;</span>%- include<span class="token punctuation">(</span><span class="token string">'user/show'</span>, <span class="token punctuation">{</span>user: user<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> %<span class="token operator">&gt;</span>
</code></pre></div><p>说明：</p> <p><strong>注意</strong>：以上语法基本一样，有一样不一样，<code>include</code>需要用<code>partial</code>代替。他们俩用法一模一样。</p> <p><code>layout</code>功能，需要在引用的页面，比如<code>index.html</code>里面使用<code>&lt;% layout('layout') -%&gt;</code>，<strong>注意</strong>：这里<code>'layout'</code>是指<code>layout.html</code>。</p> <p>还有一个比较重要的功能是<code>block</code>。它是在指定的位置插入自定义内容。类似于<code>angularjs</code>的<code>transclude</code>，<code>angular</code>的<code>&lt;ng-content select=&quot;[xxx]&quot;&gt;&lt;/ng-content&gt;</code>，<code>vue</code>的<code>&lt;slot&gt;&lt;/slot&gt;</code>。</p> <p><code>slot</code>写法：</p> <div class="language-html extra-class"><pre class="language-html"><code>&lt;%- block('head').toString() %&gt;
</code></pre></div><p><code>block('head')</code>，是一个占位标识符，<code>toString</code>是合并所有的插入使用<code>join</code>转成字符串。</p> <p>使用：</p> <div class="language-html extra-class"><pre class="language-html"><code>&lt;% block('head').append('<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/append.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>') %&gt;
&lt;% block('head').prepend('<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/prepend.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>') %&gt;
</code></pre></div><p><code>append</code>和<code>prepend</code>是插入的顺序，<code>append</code>总是插槽位置插入在最后，<code>prepend</code>总是插槽位置插入在最前。</p> <p>我们来验证一下。</p> <p>现在<code>layout.html</code>的<code>head</code>里面写上</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    &lt;%- block('head').toString() %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>index.html</code>的结尾写上</p> <div class="language-html extra-class"><pre class="language-html"><code>...
&lt;% block('head').append('<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/append.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>') %&gt;
&lt;% block('head').prepend('<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/prepend.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>') %&gt;
&lt;% block('head').prepend('<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/prepend2.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>') %&gt;
&lt;% block('head').append('<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/append2.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>') %&gt;  
</code></pre></div><p>访问首页<code>http://localhost:3000/</code>看结果。</p> <p><a href="https://user-images.githubusercontent.com/6111778/44764409-1ae34400-ab82-11e8-9177-aba90b3d799d.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/44764409-1ae34400-ab82-11e8-9177-aba90b3d799d.png" alt="7d kp 0rh t 7 i4"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>注意</strong>：<code>index.html</code>里书写<code>block('head').append</code>的位置不影响它显示插槽的位置，只受定义插槽<code>&lt;%- block('head').toString() %&gt;</code></p> <p>还有一个方法<code>replace</code>，没看懂怎么用的，文档里面也没有说明，基本<code>append</code>、<code>prepend</code>、<code>toString</code>就够用了。</p> <p>总结：<code>toString</code>是定义插槽位置，<code>append</code>、<code>prepend</code>往插槽插入指定的内容。他们主要做什么了，<code>layout</code>载入公共的<code>css</code>、<code>js</code>，如果有的页面有不一样地方，就需要插入当前页面的js了，那么一来这个插槽功能就有用，如果使用<code>layout</code>功能插入，就会包含在<code>layout</code>位置，无论是语义还是加载都是不合理的。就有了<code>block</code>的功能，在另一款模板引擎<code>Jade</code>里面也有同样的功能也叫<code>block</code>功能。</p> <h3 id="静态资源"><a href="#静态资源" class="header-anchor">#</a> 静态资源</h3> <p><code>public</code>文件夹里面内容直接拷贝<code>egg-cnode</code>下的<code>public</code>的静态资源</p> <p>还需要安装几个依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i --save loader loader-connect loader-builder
</code></pre></div><p>这几个模块是加载css和js使用，也是<a href="https://github.com/JacksonTian" target="_blank" rel="noopener noreferrer">@JacksonTian<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 朴灵大神的作品。</p> <p>main.ts配置</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> loaderConnect <span class="token keyword">from</span> <span class="token string">'loader-connect'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 根目录 nest-cnode</span>
  <span class="token keyword">const</span> rootDir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注意：这个要在express.static之前调用，loader2.0之后要使用loader-connect</span>
  <span class="token comment">// 自动转换less为css</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isDevelopment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>loaderConnect<span class="token punctuation">.</span><span class="token function">less</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 所有的静态文件路径都前缀&quot;/public&quot;, 需要使用“挂载”功能</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/public'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 官方指定是这个 默认访问根目录</span>
  <span class="token comment">// app.useStaticAssets(join(__dirname, '..', 'public'));</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注意</strong>：如果静态文件路径都前缀<code>/public</code>，需要使用<code>use</code>去挂载<code>express.static</code>路径。只有<code>express</code>是这样的</p> <div class="language-ts extra-class"><pre class="language-ts"><code>  <span class="token function">useStaticAssets</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token operator">:</span> ServeStaticOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>它的源码是这样写的，如果这样的，你的静态资源路径就是从根目录开始，如果需要加前缀<code>/public</code>，就需要<code>express</code>提供的<a href="http://expressjs.jser.us/4x_zh-cn/api.html#app.use" target="_blank" rel="noopener noreferrer">方式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>测试我们静态资源路径设置是否正常工作</p> <p>在<code>index.html</code>里面引入<code>public/images/logo.png</code>图片</p> <div class="language-html extra-class"><pre class="language-html"><code>...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/public/images/logo.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
...
</code></pre></div><p><a href="https://user-images.githubusercontent.com/6111778/44764424-2e8eaa80-ab82-11e8-9a94-44979c2265e6.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/44764424-2e8eaa80-ab82-11e8-9a94-44979c2265e6.png" alt="l8p0 psc xxuk6 zyea0nvs"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果有问题，请找原因，路径是否正确，设置是否正确，如果都ok，还是不能访问，可以联系我。</p> <p>关于<code>loader</code>使用：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> style <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">Loader</span><span class="token punctuation">(</span><span class="token string">'/public/stylesheets/index.min.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/libs/bootstrap/css/bootstrap.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/stylesheets/common.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/stylesheets/style.less'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/stylesheets/responsive.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/stylesheets/jquery.atwho.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/libs/editor/editor.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/libs/webuploader/webuploader.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/libs/code-prettify/prettify.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'/public/libs/font-awesome/css/font-awesome.css'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> config<span class="token punctuation">.</span>site_static_host<span class="token punctuation">,</span> config<span class="token punctuation">.</span>mini_assets<span class="token punctuation">)</span>
  <span class="token operator">%</span><span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> scripts <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">Loader</span><span class="token punctuation">(</span><span class="token string">'/public/index.min.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/jquery-2.1.0.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/lodash.compat.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/jquery-ujs.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/bootstrap/js/bootstrap.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/jquery.caret.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/jquery.atwho.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/markdownit.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/code-prettify/prettify.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/libs/qrcode.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/javascripts/main.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">'/public/javascripts/responsive.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> config<span class="token punctuation">.</span>site_static_host<span class="token punctuation">,</span> config<span class="token punctuation">.</span>mini_assets<span class="token punctuation">)</span>
  <span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div><ul><li><code>Loader</code>可以加载<code>.js</code>方法也可以加载<code>.coffee</code>、<code>.es</code>类型的文件，<code>.css</code>方法可以加载<code>.less</code>、<code>.styl</code>文件。</li> <li><code>Loader('/public/index.min.js')</code>是合并后名字</li> <li><code>.js('/public/libs/jquery-2.1.0.js')</code>是加载每一个文件地址</li> <li><code>.done(assets, config.site_static_host, config.mini_assets)</code>是处理文件，第一个参数合并压缩后的路径（后面讲解），第二个参数静态文件服务器地址，第三个参数是否压缩</li></ul> <p><code>assets</code>从哪里来</p> <p>在<code>package.json</code>的<code>scripts</code>配置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    ...
    <span class="token property">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token string">&quot;loader /views /&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>loader的写法是：<code>loader &lt;views_dir&gt; &lt;output_dir&gt;</code>。<code>views_dir</code>是模板引擎目录，<code>output_dir</code>是<code>assets.json</code>文件输出的目录，<code>/</code>表示根目录。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> run assets
</code></pre></div><p>直接运行会报错，这个问题在<code>egg-node</code>有人提<a href="https://github.com/cnodejs/egg-cnode/issues/129" target="_blank" rel="noopener noreferrer">issues<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://user-images.githubusercontent.com/6111778/44764434-3b130300-ab82-11e8-9322-088c7688949a.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/44764434-3b130300-ab82-11e8-9322-088c7688949a.png" alt="z90d4zb w t t26e_2 l"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>主要是静态资源<code>css</code>引用的背景图片和字体地址有错误，需要修改哪些文件：</p> <p>错误信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>no such <span class="token function">file</span> or directory, <span class="token function">open</span> <span class="token string">'E:\github<span class="token entity" title="\n">\n</span>est-cnode<span class="token entity" title="\E">\E</span>:\public\img\glyphicons-halflings.png'</span>
</code></pre></div><p>谁引用了它 <code>Error! File:/public/libs/bootstrap/css/bootstrap.css</code></p> <p>/public/libs/bootstrap/css/bootstrap.css</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">...
[class^=&quot;icon-&quot;],
[class*=&quot; icon-&quot;]</span> <span class="token punctuation">{</span>
    <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>
    *<span class="token property">margin-right</span><span class="token punctuation">:</span> .3em<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
    <span class="token property">vertical-align</span><span class="token punctuation">:</span> text-top<span class="token punctuation">;</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">&quot;/public/libs/bootstrap/img/glyphicons-halflings.png&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
    <span class="token property">background-position</span><span class="token punctuation">:</span> 14px 14px<span class="token punctuation">;</span>
    <span class="token property">background-repeat</span><span class="token punctuation">:</span> no-repeat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">...

.icon-white,
.nav-pills &gt; .active &gt; a &gt; [class^=&quot;icon-&quot;],
.nav-pills &gt; .active &gt; a &gt; [class*=&quot; icon-&quot;],
.nav-list &gt; .active &gt; a &gt; [class^=&quot;icon-&quot;],
.nav-list &gt; .active &gt; a &gt; [class*=&quot; icon-&quot;],
.navbar-inverse .nav &gt; .active &gt; a &gt; [class^=&quot;icon-&quot;],
.navbar-inverse .nav &gt; .active &gt; a &gt; [class*=&quot; icon-&quot;],
.dropdown-menu &gt; li &gt; a:hover &gt; [class^=&quot;icon-&quot;],
.dropdown-menu &gt; li &gt; a:focus &gt; [class^=&quot;icon-&quot;],
.dropdown-menu &gt; li &gt; a:hover &gt; [class*=&quot; icon-&quot;],
.dropdown-menu &gt; li &gt; a:focus &gt; [class*=&quot; icon-&quot;],
.dropdown-menu &gt; .active &gt; a &gt; [class^=&quot;icon-&quot;],
.dropdown-menu &gt; .active &gt; a &gt; [class*=&quot; icon-&quot;],
.dropdown-submenu:hover &gt; a &gt; [class^=&quot;icon-&quot;],
.dropdown-submenu:focus &gt; a &gt; [class^=&quot;icon-&quot;],
.dropdown-submenu:hover &gt; a &gt; [class*=&quot; icon-&quot;],
.dropdown-submenu:focus &gt; a &gt; [class*=&quot; icon-&quot;]</span> <span class="token punctuation">{</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">&quot;/public/libs/bootstrap/img/glyphicons-halflings-white.png&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
...
</code></pre></div><p>大约<code>2296</code>和<code>2320</code>行位置，你可以用查找搜索<code>glyphicons-halflings.png</code>，默认是<code>background-image: url(&quot;../img/glyphicons-halflings.png&quot;);</code>, 替换为上面写法。</p> <p>/public/stylesheets/style.less</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">...
.navbar .search-query</span> <span class="token punctuation">{</span>
  <span class="token property">-webkit-box-shadow</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">-moz-box-shadow</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #888 <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'/public/images/search.png'</span><span class="token punctuation">)</span></span> no-repeat 4px 4px<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 3px 5px 3px 22px<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 2px<span class="token selector">;

  &amp;:hover</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> all 0.5s<span class="token selector">;

  &amp;:focus, &amp;.focused</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
...
</code></pre></div><p>大约<code>850</code>行位置</p> <blockquote><p>简单解释就是换成相对于根目录的路径，后面错误就类似。</p></blockquote> <p><a href="https://user-images.githubusercontent.com/6111778/44764444-45350180-ab82-11e8-9f65-a6b319a11fec.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/44764444-45350180-ab82-11e8-9f65-a6b319a11fec.png" alt="45 7el q a5ph tf g84r 0"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>打包成功以后会输出一个<code>assets.json</code>在根目录。<code>assets</code>指的就是这个json文件，后面我们会讲如果把它们关联起来。</p> <h2 id="静态模板"><a href="#静态模板" class="header-anchor">#</a> 静态模板</h2> <p>我们上面已经配置好了模板引擎和静态资源，我们先要去扩展他们，先让页面好看点。</p> <p>打开<a href="https://cnodejs.org/" target="_blank" rel="noopener noreferrer">cnode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，然后右键查看源代码。把里面内容复制，拷贝到<code>index.html</code>里去。</p> <p>访问<code>http://localhost:3000/</code>就可以瞬间看到和<code>cnode</code>首页一样的内容了。</p> <p><a href="https://user-images.githubusercontent.com/6111778/44771917-006b9380-ab9f-11e8-9122-ed902df536a7.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/44771917-006b9380-ab9f-11e8-9122-ed902df536a7.png" alt="1"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>有模板以后，我们需要改造他们:</p> <ol><li>使用HTML5推荐的<code>DOCTYPE</code>申明</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh-CN<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol><li>拆分<code>body</code>标签之外到<code>layout.html</code></li></ol> <p>浏览<code>cnode</code>所有页面<code>head</code>内容，除了<code>title</code>标签内容其他一样</p> <p>基础<code>layout.html</code>模板</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh-CN<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>我是layout模板<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    &lt;%- body -%&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>把<code>index.html</code>里的<code>head</code>标签内容都移动到<code>layout.html</code>的<code>head</code>，同名的直接替换。</p> <p>替换之后的<code>layout.html</code>模板</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh-CN<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>CNode：Node.js专业中文社区<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>description<span class="token punctuation">'</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>CNode：Node.js专业中文社区<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keywords<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nodejs, node, express, connect, socket.io<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- see http://smerity.com/articles/2013/where_did_all_the_http_referrers_go.html --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>referrer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>always<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>author<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>EDP@TaoBao<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wb:webmaster<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>617be6bd946c6b96<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>csrf-param<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vlUgGvkx-SgmuzendL9gAP3DHXVS3834IpC4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>csrf-token<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>RSS<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>application/rss+xml<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>alternate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/rss<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//o4j806krb.qnssl.com/public/images/cnode_icon_32.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image/x-icon<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- style --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//o4j806krb.qnssl.com/public/stylesheets/index.min.23a5b1ca.min.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>all<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    &lt;%- block('styles').toString() %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    &lt;%- body -%&gt;
    <span class="token comment">&lt;!-- scripts --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//o4j806krb.qnssl.com/public/index.min.f7c13f64.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    &lt;%- block('scripts').toString() %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p>style放头部，script放底部，并且利用模板引擎做了2个插槽，一个<code>styles</code>和<code>scripts</code></p></blockquote> <ol><li>拆分<code>body</code>标签之内到<code>layout.html</code></li></ol> <p>浏览<code>cnode</code>所有页面内容，发现头部黑色部分和底部白色部分都是一样的。那么我们需要把它们提取出来。</p> <p><code>cnode</code>模板</p> <div class="language-html extra-class"><pre class="language-html"><code>...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>navbar<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>main<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>backtotop<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>footer<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>sidebar-mask<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>backtotop</code>和<code>sidebar-mask</code>是2个和js相关的功能标签，直接保留它们。</li> <li>class<code>navbar</code>对应到<code>header</code>标签</li> <li>id<code>main</code>对应到<code>main</code>标签</li> <li>id<code>footer</code>对应到<code>footer</code>标签</li> <li>并且把除了<code>main</code>标签之外内容都放到对应的标签里面</li> <li>模板里面关于网站访问统计的代码，我们就不需要了，直接去掉了。</li></ul> <p>改版后的<code>layout.html</code>模板</p> <div class="language-html extra-class"><pre class="language-html"><code>...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>navbar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        &lt;%- body -%&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>footer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>backtotop<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sidebar-mask<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>把剩下<code>index.html</code>里面的<code>styles</code>和<code>scripts</code>使用</p> <div class="language-html extra-class"><pre class="language-html"><code>&lt;% block('styles').append(``) %&gt;
&lt;% block('scripts').append(``) %&gt;
</code></pre></div><p>最好是写成<code>script</code>和<code>style</code>文件。</p> <ol><li>拆分<code>main</code>标签之内到<code>sidebar.html</code></li></ol> <p>浏览<code>cnode</code>所有主体内容，发现右边侧边栏除了<code>api</code>页面没有，注册登录找回密码，是另外一种模板内容，其他页面都是一样。</p> <p>当前<code>index.html</code>模板</p> <div class="language-html extra-class"><pre class="language-html"><code>...
&lt;% layout('layout') -%&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>sidebar<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>content<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
...
</code></pre></div><p>替换后的<code>index.html</code>模板</p> <div class="language-html extra-class"><pre class="language-html"><code>...
&lt;% layout('layout') -%&gt;
&lt;%- partial('./sidebar.html') %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">&gt;</span></span>
...
</code></pre></div><p>这样我们首页模板已经完成了。</p> <h2 id="系统配置和应用配置"><a href="#系统配置和应用配置" class="header-anchor">#</a> 系统配置和应用配置</h2> <p>系统配置是系统级别的配置，如数据配置，端口，host，签名，加密keys等</p> <p>应用配置是应用级别的配置，如网站标题，关键字，描述等</p> <p>系统配置使用<code>.env</code>文件，大部分语言都有这个文件，我们需要用<code>dotenv</code>读取它们里面的内容。</p> <p><code>dotenv</code>支持的<code>.env</code>语法：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 测试单行注释</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token string">''</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span>value
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token string">'value'</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;foo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token string">'{&quot;foo&quot;: &quot;bar&quot;}'</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span>, <span class="token string">&quot;bar&quot;</span><span class="token punctuation">]</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token string">'[&quot;foo&quot;, &quot;bar&quot;]'</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span>true
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token string">'0'</span>
<span class="token assign-left variable">KEY</span><span class="token operator">=</span>null
<span class="token assign-left variable">KEY</span><span class="token operator">=</span><span class="token string">'null'</span>
</code></pre></div><blockquote><p><code>.env</code> 语法非常简单，<code>key</code> 只能是字符串（ps：最好大写带下划线分割单词），<code>value</code> 可以是空、字符串、数字、布尔值、字典对象、数组，<code>dotenv</code>最后获取也是字符串，需要你做相应处理。</p></blockquote> <p><strong>注意</strong>：<code>.env</code> 文件主要的作用是存储环境变量，也就是会随着环境变化的东西，比如数据库的用户名、密码、静态文件的存储路径之类的，因为这些信息应该是和环境绑定的，不应该随代码的更新而变化，所以一般不会把 <code>.env</code> 文件放到版本控制中；</p> <p>我们需要在<code>.gitignore</code>文件中排除它们：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># dotenv environment variables file</span>
*.env
.env
</code></pre></div><blockquote><p><code>.env</code>配置文件，关于隐私配置，可以看<code>README.md</code>说明。<code>.env</code>文件模板</p></blockquote> <h3 id="configmodule-配置模块"><a href="#configmodule-配置模块" class="header-anchor">#</a> ConfigModule（配置模块）</h3> <p>当我们使用<code>process global</code>对象时，很难保持测试的干净，因为测试类可能直接使用它。另一种方法是创建一个抽象层，即一个<code>ConfigModule</code>，它公开了一个装载配置变量的<code>ConfigService</code>。</p> <p>关于配置模块，官网有详细的<a href="https://docs.nestjs.com/techniques/configuration" target="_blank" rel="noopener noreferrer">栗子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这里也是基本类似。这里说一些关键点：</p> <ol><li>需要用到依赖：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i --save dotenv  // 用来解析<span class="token variable"><span class="token variable">`</span>.env<span class="token variable">`</span></span>配置文件

<span class="token function">npm</span> <span class="token function">install</span> --save joi  // 用来验证<span class="token variable"><span class="token variable">`</span>.env<span class="token variable">`</span></span>配置文件
<span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/joi
</code></pre></div><ol><li>需要创建<code>.env</code>配置文件</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code> development.env  开发配置
 production.env  生产配置
 test.env  测试配置
 .env.tmp  .env配置文件模板
</code></pre></div><ol><li>怎么设置<code>NODE_ENV</code></li></ol> <p><code>windows</code>和<code>mac</code>不一样</p> <p>windows设置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set NODE_ENV=development&amp;&amp; nodemon&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set NODE_ENV=production&amp;&amp; node dist/main.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set NODE_ENV=test&amp;&amp; jest&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>mac设置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;export NODE_ENV=development&amp;&amp; nodemon&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;export NODE_ENV=production&amp;&amp; node dist/main.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;export NODE_ENV=test&amp;&amp; jest&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你会发现这个很麻烦，有没有什么方便地方了，可以通过<code>cross-env</code>来解决问题，它就是解决跨平台设置NODE_ENV的问题，默认情况下，windows不支持NODE_ENV=development的设置方式，加上cross-env就可以跨平台。</p> <p>安装<code>cross-env</code>依赖</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i --save-dev cross-env
</code></pre></div><p><code>cross-env</code>设置</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=development nodemon&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production node dist/main.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=test jest&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>创建<code>config</code>模块:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module config
OR
$ nest g mo config
</code></pre></div><ul><li>创建全局模块，全局模块不需要在注入到该模块，就能使用该模块导出的服务。</li> <li>创建动态模块，动态模块可以创建可定制的模块，动态做依赖注入关系。</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module<span class="token punctuation">,</span> DynamicModule<span class="token punctuation">,</span> Global <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigurationToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EnvConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.interface'</span><span class="token punctuation">;</span>

@<span class="token function">Global</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConfigModule</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> EnvConfig<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>filePath<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> validator<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>envConfig<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> DynamicModule <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token keyword">module</span><span class="token operator">:</span> ConfigModule<span class="token punctuation">,</span>
            providers<span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    provide<span class="token operator">:</span> ConfigService<span class="token punctuation">,</span>
                    useValue<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span>filePath <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.env</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> validator<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    provide<span class="token operator">:</span> ConfigToken<span class="token punctuation">,</span>
                    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span>filePath <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.env</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> validator<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            exports<span class="token operator">:</span> <span class="token punctuation">[</span>
                ConfigService<span class="token punctuation">,</span>
                ConfigToken<span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>&lt;T = EnvConfig&gt;</code>是一种什么写法，<code>T</code>是一个泛型，<code>EnvConfig</code>是一个默认值，如果使用者不传递就是默认类型，作用类似于函数默认值。</p> <p>默认用2种注册服务的写法，一种是类，一种是工厂。前面基础篇已经提及了，后面讲怎么使用它们。</p> <ol><li>创建<code>config</code>服务:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate <span class="token function">service</span> config/config
OR
$ nest g s config/config
</code></pre></div><p>首先,让我们写<code>ConfigService</code>类。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EnvConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.interface'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConfigService<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> EnvConfig<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 系统配置</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> envConfig<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> validator<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>envConfig<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解析配置文件</span>
        <span class="token keyword">const</span> configFile<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 验证配置参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> validator <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> envConfig<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token function">validator</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> envConfig <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'validator return value is not object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig <span class="token operator">=</span> envConfig<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig <span class="token operator">=</span> configFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取配置
     * @param key
     * @param defaultVal
     */</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> defaultVal<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> defaultVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 获取系统配置 */</span>
    <span class="token function">getKeys</span><span class="token punctuation">(</span>keys<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> keys<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取数字
     * @param key
     */</span>
    <span class="token function">getNumber</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取布尔值
     * @param key
     */</span>
    <span class="token function">getBoolean</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取字典对象和数组
     * @param key
     */</span>
    <span class="token function">getJson</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>prop<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检查一个key是否存在
     * @param key
     */</span>
    <span class="token function">has</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 开发模式 */</span>
    <span class="token keyword">get</span> <span class="token function">isDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/** 生产模式 */</span>
    <span class="token keyword">get</span> <span class="token function">isProduction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/** 测试模式 */</span>
    <span class="token keyword">get</span> <span class="token function">isTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解析数据都存在<code>envConfig</code>里，封装一些获取并转义<code>value</code>的方法。</p> <p>传递2个参数，一个是<code>.env</code>文件路径，一个是验证器，配合<code>Joi</code>使用，<code>nest</code>官网文档把配置服务和验证字段放在一起，我觉得这样不是很科学。
我在<code>.env</code>加一个配置就需要去修改<code>ConfigService</code>类，它本来就是不需要修改的，我就把验证部分提取出来，这样就不用关心验证问题了。<code>ConfigService</code>只关心取值问题。</p> <p>上面模块里面还有一个<code>ConfigToken</code>服务，它是做什么的了，它叫做令牌。</p> <ol><li>我们创建一个常量文件：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">touch</span> src/config/config.constants.ts
OR
编辑器新建文件config.constants.ts
</code></pre></div><p>里面写入常量<code>configToken</code>并导出</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> const ConfigToken <span class="token operator">=</span> <span class="token string">'ConfigToken'</span><span class="token punctuation">;</span>
</code></pre></div><p><code>ConfigModule</code>的<code>configToken</code>也是它。</p> <ol><li>我们创建一个装饰器文件：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">touch</span> src/config/config.decorators.ts
OR
编辑器新建文件config.decorators.ts
<span class="token function">import</span> <span class="token punctuation">{</span> Inject <span class="token punctuation">}</span> from <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token function">import</span> <span class="token punctuation">{</span> ConfigToken <span class="token punctuation">}</span> from <span class="token string">'./config.constants'</span><span class="token punctuation">;</span>

<span class="token builtin class-name">export</span> const InjectConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Inject<span class="token punctuation">(</span>ConfigToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用<code>Inject</code>依赖注入器注入令牌对应的服务</p> <p><code>InjectConfig</code>是一个装饰器。装饰器在<code>nest</code>、<code>angular</code>有大量实践案例，各种装饰器，让你眼花缭乱。</p> <p>简单科普一下装饰器：</p> <p>写法：（总共四种：类，属性，方法，方法参数）</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">ClassDecorator</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>TFunction <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">Function</span></span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token operator">:</span> TFunction<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TFunction <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">PropertyDecorator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> Object<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">MethodDecorator</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token operator">:</span> Object<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> descriptor<span class="token operator">:</span> TypedPropertyDescriptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TypedPropertyDescriptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">ParameterDecorator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> Object<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> parameterIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre></div><p>执行顺序：</p> <ul><li>类装饰器总是最后执行。</li> <li>有多个方法参数装饰器时：从最后一个参数依次向前执行。</li> <li>方法参数装饰器中参数装饰器先执行，方法参数装饰器执行完以后，方法装饰器执。</li> <li>方法和属性装饰器，谁在前面谁先执行。（ps：方法参数属于方法一部分，参数会一直紧紧挨着方法执行。）</li></ul> <ol><li>如何使用<code>config</code></li></ol> <p>2种方式：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 装饰器依赖注入</span>
<span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> config<span class="token operator">:</span> ConfigService<span class="token operator">&lt;</span>EnvConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 普通依赖注入</span>
<span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> config<span class="token operator">:</span> ConfigService<span class="token operator">&lt;</span>EnvConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 通过app实例取</span>
<span class="token keyword">const</span> config<span class="token operator">:</span> ConfigService<span class="token operator">&lt;</span>EnvConfig<span class="token operator">&gt;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>ConfigService<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>isDevelopment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>loaderConnect<span class="token punctuation">.</span><span class="token function">less</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">'PORT'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>普通依赖注入就够玩了，这里用装饰器依赖注入有些画蛇添足，只是说明装饰器和注入器注入令牌用法。
通过app实例取，一般用于系统启动初始化配置，后面还要其他的获取方式，用到在介绍。</p> <h3 id="config-应用配置"><a href="#config-应用配置" class="header-anchor">#</a> Config（应用配置）</h3> <p>应用配置对比系统配置就没有这么麻烦了，大多数数据都可以写死就行了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">touch</span> src/core/constants/config.constants.ts
OR
编辑器新建文件config.constants.ts
</code></pre></div><p>参考<code>cnode-egg</code>的<code>config/config.default.js</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> Config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 网站名字、标题</span>
    name<span class="token operator">:</span> <span class="token string">'CNode技术社区'</span><span class="token punctuation">,</span>
    <span class="token comment">// 网站关键词</span>
    keywords<span class="token operator">:</span> <span class="token string">'nodejs, node, express, connect, socket.io'</span><span class="token punctuation">,</span>
    <span class="token comment">// 网站描述</span>
    description<span class="token operator">:</span> <span class="token string">'CNode：Node.js专业中文社区'</span><span class="token punctuation">,</span>
    <span class="token comment">// logo</span>
    logo<span class="token operator">:</span> <span class="token string">'/public/images/cnodejs_light.svg'</span><span class="token punctuation">,</span>
    <span class="token comment">// icon</span>
    icon<span class="token operator">:</span> <span class="token string">'/public/images/cnode_icon_32.png'</span><span class="token punctuation">,</span>
    <span class="token comment">// 版块</span>
    tabs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token string">'全部'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'good'</span><span class="token punctuation">,</span> <span class="token string">'精华'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'share'</span><span class="token punctuation">,</span> <span class="token string">'分享'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ask'</span><span class="token punctuation">,</span> <span class="token string">'问答'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">,</span> <span class="token string">'招聘'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'测试'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// RSS配置</span>
    rss<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
        language<span class="token operator">:</span> <span class="token string">'zh-cn'</span><span class="token punctuation">,</span>
        description<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">,</span>
        <span class="token comment">// 最多获取的RSS Item数量</span>
        max_rss_items<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 帖子配置</span>
    topic<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 列表分页20</span>
        list_count<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token comment">// 每天每用户限额计数10</span>
        perDayPerUserLimitCount<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 用户配置</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 每个 IP 每天可创建用户数</span>
        create_user_per_ip<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 默认搜索方式</span>
    search<span class="token operator">:</span> <span class="token string">'baidu'</span><span class="token punctuation">,</span> <span class="token comment">// 'google', 'baidu', 'local'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>哪里需要直接导入就行了，这个比较简单。</p> <p>系统配置和应用配置告一段落了，那么接下来需要配置数</p> <h3 id="mongoose连接"><a href="#mongoose连接" class="header-anchor">#</a> mongoose连接</h3> <p>关于<code>mongoDB</code>安装，创建数据库，连接认证等操作，这里就展开了，这里有篇<a href="https://github.com/jiayisheji/jianshu/blob/master/blog/%E8%BF%9E%E6%8E%A5MongoDB.md" target="_blank" rel="noopener noreferrer">文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在<code>.env</code>文件里面，我们已经配置<code>mongoDB</code>相关数据。</p> <ol><li>创建核心模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module core
OR
$ nest g mo core
</code></pre></div><p>核心模块，只会注入到<code>AppModule</code>，不会注入到<code>feature</code>和<code>shared</code>模块里面，专门做初始化配置工作，不需要导出任何模块。</p> <p>它里面包括：守卫，管道，过滤器、拦截器、中间件、全局模块、常量、装饰器</p> <p>其中全局中间件和全局模块需要模块里面注入和配置。</p> <ol><li>配置<code>ConfigModule</code></li></ol> <p>前面我们已经定义好了<code>ConfigModule</code>，现在把它添加到<code>CoreModule</code>中</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule<span class="token punctuation">,</span> EnvConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigValidate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.validate'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        ConfigModule<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&lt;</span>EnvConfig<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> ConfigValidate<span class="token punctuation">.</span>validateInput<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ConfigValidate.validateInput</code> 是一个验证 <code>.env</code> 方法，<code>nest</code>和官网文档一样.</p> <ol><li>配置<code>mongooseModule</code></li></ol> <p><code>nest</code>为我们提供了<code>@nestjs/mongoose</code>。</p> <p>安装依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/mongoose mongoose
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/mongoose
</code></pre></div><p>配置模块：<a href="https://docs.nestjs.com/techniques/mongodb" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongooseModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span>
        MongooseModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>MongooseModule</code>提供了2个静态方法：</p> <ul><li>forRoot(url, config): 对应的<code>Mongoose.connect()</code>方法</li> <li>forRootAsync({
imports,
useFactory,
inject
}): <code>useFactory</code>返回对应的<code>Mongoose.connect()</code>方法参数，<code>imports</code>依赖模块，<code>inject</code>依赖服务</li> <li>forFeature([{ name, schema }]): 对应的<code>mongoose.model()</code>方法</li> <li>constructor(@InjectModel('Cat') private readonly catModel: Model) {}：<code>@InjectModel</code>获取<code>mongoose.model</code>，参数和<code>forFeature</code>的<code>name</code>一样。</li></ul> <p>根模块使用: (forRoot和forRootAsync，只能注入一次，所以要在根模块导入)</p> <p>这里我们需要借助配置模块里面获取配置，需要用到<code>forRootAsync</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongooseModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span>
        MongooseModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
                uri<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'MONGODB_URI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inject<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果要写<code>MongooseOptions</code>怎么办</p> <p>直接在uri后面写，有个必须的配置要写：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>DeprecationWarning: current URL string parser is deprecated, and will be removed <span class="token keyword">in</span> a future version. To use the new parser, pass option <span class="token punctuation">{</span> useNewUrlParser: <span class="token boolean">true</span> <span class="token punctuation">}</span> to MongoClient.connect.
</code></pre></div><p>其他配置根据自己需求来添加</p> <p>如果启动失败会显示：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>MongoError: Authentication failed.
</code></pre></div><p>请检查uri是否正确，如果启动验证，账号是否验证通过，数据库名是否正确等等。</p> <p>数据库连接成功，我们进行下一步，定义用户表。</p> <h3 id="用户数据库模块"><a href="#用户数据库模块" class="header-anchor">#</a> 用户数据库模块</h3> <p>建立数据模型为后面控制器提供服务</p> <h4 id="生成文件"><a href="#生成文件" class="header-anchor">#</a> 生成文件</h4> <ol><li>创建<code>shared</code>模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module shared
OR
$ nest g mo shared
</code></pre></div><ol><li>创建<code>mongodb</code>模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module shared/mongodb
OR
$ nest g mo shared/mongodb
</code></pre></div><ol><li>创建<code>user</code>模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module shared/mongodb/user
OR
$ nest g mo shared/mongodb/user
</code></pre></div><ol><li>创建<code>user</code>服务</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate <span class="token function">service</span> shared/mongodb/user
OR
$ nest g s shared/mongodb/user
</code></pre></div><ol><li>创建<code>user</code>的<code>interface</code>、<code>schema</code>、<code>index</code>。</li></ol> <p>这三个文件无法用命令创建需要自己手动创建。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">touch</span> src/shared/mongodb/user/user.interface.ts
$ <span class="token function">touch</span> src/shared/mongodb/user/user.schema.ts
$ <span class="token function">touch</span> src/shared/mongodb/user/index.ts
OR
编辑器新建文件<span class="token variable"><span class="token variable">`</span>user.interface.ts<span class="token variable">`</span></span>
编辑器新建文件<span class="token variable"><span class="token variable">`</span>user.schema.ts<span class="token variable">`</span></span>
编辑器新建文件<span class="token variable"><span class="token variable">`</span>index.ts<span class="token variable">`</span></span>
</code></pre></div><ul><li><code>interface</code>是<code>ts</code>接口定义ts</li> <li><code>schema</code>是定义<code>mongodb</code>的<code>schema</code></li></ul> <p>最后完整的<code>user</code>文件夹是：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>index.ts
user.module.ts
user.service.ts
user.schema.ts
user.interface.ts
</code></pre></div><blockquote><p>基本所有的<code>mongodb</code>模块都是这样的结构，后面不在介绍<code>生成文件</code>这项。</p></blockquote> <h4 id="定义服务"><a href="#定义服务" class="header-anchor">#</a> 定义服务</h4> <p>默认生产的模块文件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在正式写<code>UserService</code>之前，我们先思考一个问题，因为操作数据库服务基本都类似，常用几个方法如：</p> <ul><li>findAll 获取指定条件全部数据</li> <li>paginator 带分页结构数据</li> <li>findOne 获取一个数据</li> <li>findById 获取指定id数据</li> <li>count 获取指定条件个数</li> <li>create 创建数据</li> <li>delete 删除数据</li> <li>update 更新数据</li></ul> <p>一个基本表应该有增删改查这样8个快捷操作方法，如果每个表都写一个这样的，就比较多余了。<code>Typescript</code>给我们提供一个抽象类，我们可以把这些公共方法写在里面，然后用其他服务来继承。那我们开始写<code>base.service.ts</code>:</p> <p>base.service.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * 抽象CRUD操作基础服务
 * @export
 * @abstract
 * @class BaseService
 * @template T
 */</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseService<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Document<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> _model<span class="token operator">:</span> Model<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取指定条件全部数据
     * @param {*} conditions
     * @param {(any | null)} [projection]
     * @param {({
     *         sort?: any;
     *         limit?: number;
     *         skip?: number;
     *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;
     *         [key: string]: any;
     *     })} [options]
     * @returns {Promise&lt;T[]&gt;}
     * @memberof BaseService
     */</span>
    <span class="token function">findAll</span><span class="token punctuation">(</span>conditions<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> projection<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        sort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
        limit<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        skip<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        populates<span class="token operator">?</span><span class="token operator">:</span> ModelPopulateOptions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> ModelPopulateOptions<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> option<span class="token punctuation">,</span> populates <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">const</span> docsQuery <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">populates</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>docsQuery<span class="token punctuation">,</span> populates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取带分页数据
     * @param {*} conditions
     * @param {(any | null)} [projection]
     * @param {({
     *         sort?: any;
     *         limit?: number;
     *         offset?: number;
     *         page?: number;
     *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;
     *         [key: string]: any;
     *     })} [options]
     * @returns {Promise&lt;Paginator&lt;T&gt;&gt;}
     * @memberof BaseService
     */</span>
    <span class="token keyword">async</span> <span class="token function">paginator</span><span class="token punctuation">(</span>conditions<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> projection<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        sort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
        limit<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        offset<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        page<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        populates<span class="token operator">?</span><span class="token operator">:</span> ModelPopulateOptions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> ModelPopulateOptions<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Paginator<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result<span class="token operator">:</span> Paginator<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            data<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            total<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            limit<span class="token operator">:</span> options<span class="token punctuation">.</span>limit <span class="token operator">?</span> options<span class="token punctuation">.</span>limit <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            page<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            pages<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> offset<span class="token punctuation">,</span> page<span class="token punctuation">,</span> option <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>offset <span class="token operator">=</span> options<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>skip <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>page <span class="token operator">=</span> page<span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>skip <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> result<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
            result<span class="token punctuation">.</span>pages <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>total <span class="token operator">/</span> result<span class="token punctuation">.</span>limit<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span>skip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>total <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>conditions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取单条数据
     * @param {*} conditions
     * @param {*} [projection]
     * @param {({
     *         lean?: boolean;
     *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;
     *         [key: string]: any;
     *     })} [options]
     * @returns {(Promise&lt;T | null&gt;)}
     * @memberof BaseService
     */</span>
    <span class="token function">findOne</span><span class="token punctuation">(</span>conditions<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> projection<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        lean<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
        populates<span class="token operator">?</span><span class="token operator">:</span> ModelPopulateOptions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> ModelPopulateOptions<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> option<span class="token punctuation">,</span> populates <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">const</span> docsQuery <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">populates</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>docsQuery<span class="token punctuation">,</span> populates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据id获取单条数据
     * @param {(any | string | number)} id
     * @param {*} [projection]
     * @param {({
     *         lean?: boolean;
     *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;
     *         [key: string]: any;
     *     })} [options]
     * @returns {(Promise&lt;T | null&gt;)}
     * @memberof BaseService
     */</span>
    <span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">,</span> projection<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        lean<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
        populates<span class="token operator">?</span><span class="token operator">:</span> ModelPopulateOptions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> ModelPopulateOptions<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> option<span class="token punctuation">,</span> populates <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">const</span> docsQuery <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toObjectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> projection<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">populates</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>docsQuery<span class="token punctuation">,</span> populates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取指定查询条件的数量
     * @param {*} conditions
     * @returns {Promise&lt;number&gt;}
     * @memberof UserService
     */</span>
    <span class="token function">count</span><span class="token punctuation">(</span>conditions<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span>conditions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建一条数据
     * @param {T} docs
     * @returns {Promise&lt;T&gt;}
     * @memberof BaseService
     */</span>
    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>docs<span class="token operator">:</span> Partial<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除指定id数据
     * @param {string} id
     * @returns {Promise&lt;T&gt;}
     * @memberof BaseService
     */</span>
    <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">/** if multiple docs are found by the conditions, sets the sort order to choose which doc to update */</span>
        sort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
        <span class="token comment">/** sets the document fields to return */</span>
        select<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">findByIdAndRemove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toObjectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新指定id数据
     * @param {string} id
     * @param {Partial&lt;T&gt;} [item={}]
     * @returns {Promise&lt;T&gt;}
     * @memberof BaseService
     */</span>
    <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> update<span class="token operator">:</span> Partial<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> options<span class="token operator">:</span> ModelFindByIdAndUpdateOptions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toObjectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除所有匹配条件的文档集合
     * @param {*} [conditions={}]
     * @returns {Promise&lt;WriteOpResult['result']&gt;}
     * @memberof BaseService
     */</span>
    <span class="token keyword">async</span> <span class="token function">clearCollection</span><span class="token punctuation">(</span>conditions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>WriteOpResult<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">.</span><span class="token function">deleteMany</span><span class="token punctuation">(</span>conditions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 转换ObjectId
     * @private
     * @param {string} id
     * @returns {Types.ObjectId}
     * @memberof BaseService
     */</span>
    <span class="token keyword">private</span> <span class="token function">toObjectId</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> Types<span class="token punctuation">.</span>ObjectId <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Types<span class="token punctuation">.</span><span class="token function">ObjectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 填充其他模型
     * @private
     * @param {*} docsQuery
     * @param {*} populates
     * @returns {(Promise&lt;T | T[] | null&gt;)}
     * @memberof BaseService
     */</span>
    <span class="token keyword">private</span> <span class="token generic-function"><span class="token function">populates</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">R</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>docsQuery<span class="token punctuation">,</span> populates<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">R</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>populates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>populates<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                docsQuery<span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> docsQuery<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里说几个上面没有提到的属性和方法：</p> <ul><li>_model：当前模型的实例，我们使用它去扩展其他方法，如果上面方法不满足我们需求，我们可以随时自定义</li> <li>clearCollection：删除所有匹配条件的文档集合</li> <li>toObjectId：字符串 id 转换ObjectId</li></ul> <p>那么我们接下来的<code>UserService</code>就简单多了</p> <p>user.service.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../base.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Model <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.interface'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        @<span class="token function">InjectModel</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> userModel<span class="token operator">:</span> Model<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>BaseService</code>是一个泛型，泛型是什么，简单理解就是你传什么它就是什么。<code>T</code>需要把我们<code>User</code>类型传进去,返回都是<code>User</code>类型，使用<code>@InjectModel('User')</code>注入模型实例，最后赋值给<code>_model</code>。</p> <p>我们现在数据库<code>UserService</code>就已经完成了，接下来就需要定义<code>schema</code>和<code>interface</code>。</p> <h4 id="定义schema"><a href="#定义schema" class="header-anchor">#</a> 定义schema</h4> <p>有了上面服务的经验，现在是不是你会说<code>schema</code>有没有公用的，当然可以呀。</p> <p>我们定一个<code>base.schema.ts</code>，思考一下需要抽出来，好像唯一可以抽出来就是：</p> <ul><li>create_at：创建时间</li> <li>update_at: 更新时间</li></ul> <p>这2个我们可以用抽出来，可以使用<code>schema</code>配置参数里面的<code>timestamps</code>属性，可以开启它，它默认<code>createdAt</code>和<code>updatedAt</code>。我们修改它们字段名，使用它们好处，创建自动赋值，修改时候自动更新。
<strong>注意</strong>：它们的存的时间和本地时间相差8小时，这个后面说怎么处理。</p> <p>那么我们最终的配置就是：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> schemaOptions<span class="token operator">:</span> SchemaOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    toJSON<span class="token operator">:</span> <span class="token punctuation">{</span>
        virtuals<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        getters<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    timestamps<span class="token operator">:</span> <span class="token punctuation">{</span>
        createdAt<span class="token operator">:</span> <span class="token string">'create_at'</span><span class="token punctuation">,</span>
        updatedAt<span class="token operator">:</span> <span class="token string">'update_at'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>toJSON</code>是做什么的，我们需要开启显示<code>virtuals</code>虚拟数据，<code>getters</code>获取数据。</p> <p>关于schema定义</p> <p>在创建表之前我们需要跟大家说一下mongoDB的数据类型，具体数据类型如下：</p> <ul><li>字符串 - 这是用于存储数据的最常用的数据类型。<code>MongoDB</code>中的字符串必须为<code>UTF-8</code>。</li> <li>整型 - 此类型用于存储数值。 整数可以是32位或64位，具体取决于服务器。</li> <li>布尔类型 - 此类型用于存储布尔值(true / false)值。</li> <li>双精度浮点数 - 此类型用于存储浮点值。</li> <li>最小/最大键 - 此类型用于将值与最小和最大<code>BSON</code>元素进行比较。</li> <li>数组 - 此类型用于将数组或列表或多个值存储到一个键中。</li> <li>时间戳 - <code>ctimestamp</code>当文档被修改或添加时，可以方便地进行录制。</li> <li>对象 - 此数据类型用于嵌入式文档。</li> <li>对象 - 此数据类型用于嵌入式文档。</li> <li>Null - 此类型用于存储Null值。</li> <li>符号 - 该数据类型与字符串相同; 但是，通常保留用于使用特定符号类型的语言。</li> <li>日期 - 此数据类型用于以UNIX时间格式存储当前日期或时间。您可以通过创建日期对象并将日，月，年的日期进行指定自己需要的日期时间。</li> <li>对象ID - 此数据类型用于存储文档的ID。</li> <li>二进制数据 - 此数据类型用于存储二进制数据。</li> <li>代码 - 此数据类型用于将JavaScript代码存储到文档中。</li> <li>正则表达式 - 此数据类型用于存储正则表达式。</li></ul> <p><code>mongoose</code>使用<code>Schema</code>所定义的数据模型，再使用<code>mongoose.model(modelName, schema)</code>将定义好的<code>Schema</code>转换为<code>Model</code>。
在<code>Mongoose</code>的设计理念中，<code>Schema</code>用来也只用来定义数据结构，具体对数据的增删改查操作都由<code>Model</code>来执行</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 定义你的Schema</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UserSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 索引</span>
UserSchema<span class="token punctuation">.</span><span class="token function">virtual</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 虚拟值</span>
UserSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 中间件</span>
UserSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">xxx</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 实例方法</span>
UserSchema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">xxx</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 静态方法</span>
UserSchema<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function-variable function">xxx</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 查询助手</span>
UserSchema<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function-variable function">xxx</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 查询助手</span>
</code></pre></div><blockquote><p><strong>注意</strong>：这里面都要使用普通函数<code>function(){}</code>，不能使用<code>()=&gt;{}</code>，原因你懂的。</p></blockquote> <p>user.schema.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 引入mongoose包</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token comment">// 一个工具包，使用MD5方法加密</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> utility <span class="token keyword">from</span> <span class="token string">'utility'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入user接口</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.interface'</span><span class="token punctuation">;</span>

<span class="token comment">// 定义schema并导出</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loginname<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    pass<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    email<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    profile_image_url<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    location<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    signature<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    profile<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    weibo<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    avatar<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    githubId<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    githubUsername<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    githubAccessToken<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
    is_block<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> Boolean<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> schemaOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置索引</span>
UserSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loginname<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UserSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UserSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span> score<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UserSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span> githubId<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UserSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span> accessToken<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置虚拟属性</span>
UserSchema<span class="token punctuation">.</span><span class="token function">virtual</span><span class="token punctuation">(</span><span class="token string">'avatar_url'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>avatar <span class="token operator">||</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://gravatar.com/avatar/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>utility<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>email<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?size=48</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">// www.gravatar.com 被墙</span>
    url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'www.gravatar.com'</span><span class="token punctuation">,</span> <span class="token string">'gravatar.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 让协议自适应 protocol，使用 `//` 开头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'http:'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果是 github 的头像，则限制大小</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'githubusercontent'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url <span class="token operator">+=</span> <span class="token string">'&amp;s=120'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> url<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><blockquote><p><strong>注意</strong>：这里面使用<code>utility</code>工具包，需要安装一下，<code>npm install utility --save</code>。</p></blockquote> <h4 id="定义interface"><a href="#定义interface" class="header-anchor">#</a> 定义interface</h4> <p>因为有些公共的字段，我们在定义<code>interface</code>时候也需要抽离出来。使用<code>base.interface.ts</code></p> <p>base.interface.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Document<span class="token punctuation">,</span> Types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">BaseInterface</span> <span class="token keyword">extends</span> <span class="token class-name">Document</span> <span class="token punctuation">{</span>
    _id<span class="token operator">:</span> Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">;</span>  <span class="token comment">// mongodb id</span>
    id<span class="token operator">:</span> Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">;</span> <span class="token comment">// mongodb id</span>
    create_at<span class="token operator">:</span> Date<span class="token punctuation">;</span> <span class="token comment">// 创建时间</span>
    update_at<span class="token operator">:</span> Date<span class="token punctuation">;</span> <span class="token comment">// 更新时间</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>interface</code> 文件内容和 <code>schema</code> 的基本一样，只需要字段名和类型就好了。</p> <p>user.interface.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> BaseInterface <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../base.interface'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseInterface</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>  <span class="token comment">// 显示名字</span>
    loginname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>  <span class="token comment">// 登录名</span>
    pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// 密码</span>
    age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>  <span class="token comment">// 年龄</span>
    email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>  <span class="token comment">// 邮箱</span>
    active<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>  <span class="token comment">// 是否激活</span>
    collect_topic_count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>  <span class="token comment">// 收集话题数</span>
    topic_count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>  <span class="token comment">// 发布话题数</span>
    score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>   <span class="token comment">// 积分</span>
    is_star<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>  <span class="token comment">//</span>
    is_block<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> <span class="token comment">// 是否黑名单</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意</strong>：如果是<code>schema</code>里面不是定义必填或者有默认值的字段，需要这样写<code>is_admin?: boolean;</code>，<code>?</code>表示该字段可选的。最好在<code>interface</code>里面写上每个字段加上注释，方便查看。</p></blockquote> <h4 id="定义模块"><a href="#定义模块" class="header-anchor">#</a> 定义模块</h4> <p>默认生产的模块文件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>上面<code>schema</code>和<code>service</code>，都定义好了，接下来我们需要在模块里面注册。</p> <p>user.module.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment">// 引入 nestjs 提供的 mongoose 模块</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongooseModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

<span class="token comment">// 引入自己写的 schema 和 service 在模块里面注册</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserSchema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.schema'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        MongooseModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token operator">:</span> UserSchema <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>UserService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">[</span>UserService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p><code>forFeature([{ name: 'User', schema: UserSchema }])</code>就是<code>MongooseModule</code>为什么提供的<code>mongoose.model(modelName, schema)</code>操作</p> <blockquote><p><strong>注意</strong>：<code>providers</code>是注册服务，如果想要给其他模块使用，需要在<code>exports</code>导出。</p></blockquote> <h4 id="定义索引文件"><a href="#定义索引文件" class="header-anchor">#</a> 定义索引文件</h4> <p>index.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./user.module'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./user.interface'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p><strong>注意</strong>：不是所有的文件都需要导出的，一些关键的文件，其他模块需要使用的，如果<code>interface</code>、<code>service</code>都是需要导出的。</p></blockquote> <p>其他文件访问</p> <p>xxx.service.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">,</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user'</span><span class="token punctuation">;</span>
</code></pre></div><p>是不是很方便。</p> <h3 id="shared-模块和-mongodb-模块"><a href="#shared-模块和-mongodb-模块" class="header-anchor">#</a> shared 模块和 mongodb 模块</h3> <h4 id="mongodb模块"><a href="#mongodb模块" class="header-anchor">#</a> mongodb模块</h4> <p><code>mongodb</code>模块是管理所有<code>mongodb</code>文件夹里模块导入导出</p> <p>mongodb.module.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>UserModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">[</span>UserModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MongodbModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>建立索引文件<code>index.ts</code>导出<code>mongodb</code>文件夹下所有文件夹</p></blockquote> <h4 id="shared模块"><a href="#shared模块" class="header-anchor">#</a> shared模块</h4> <p><code>shared</code>模块是管理所有<code>shared</code>文件夹里模块导入导出</p> <p>shared.module.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongodbModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mongodb'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>MongodbModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">[</span>MongodbModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SharedModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>建立索引文件<code>index.ts</code>导出<code>shared</code>文件夹下所有文件夹</p></blockquote> <p>到这里我们<code>user</code>数据表模块就基本完成了，接下来就需要使用它们。我们也可以运行<code>npm run start:dev</code>，不会出现任何错误，如果有错，请检查你的文件是否正确。如果找不到问题，可以联系我。</p> <p><strong>注意</strong>：后面我们搭建数据库就不再如此详细说明，只是一笔带过，大家可以看源码。</p> <h2 id="注册和使用node-mailer发送邮件"><a href="#注册和使用node-mailer发送邮件" class="header-anchor">#</a> 注册和使用<code>node-mailer</code>发送邮件</h2> <p>如果有用户模块功能，登陆注册应该说是必备的入门功能。</p> <p>先说一下我们登陆注册逻辑：</p> <ol><li>我们主要使用<code>passport、passport-github、passport-local</code>这三个模块，做身份认证。</li> <li>支持本地注册登陆和<code>github</code>第三方认证登陆（后面会介绍github认证登陆怎么玩）</li> <li>使用<code>session</code>和<code>cookie</code>，30天内免登陆</li> <li>退出后清除<code>session</code>和<code>cookie</code></li> <li>支持电子邮箱找回密码</li></ol> <p>这里注册、登录、登出、找回密码都放在这个模块里面</p> <h3 id="生成文件-2"><a href="#生成文件-2" class="header-anchor">#</a> 生成文件</h3> <ol><li>创建<code>feature</code>模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module feature
OR
$ nest g mo feature
</code></pre></div><ol><li>创建<code>auth</code>模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate module feature/auth
OR
$ nest g mo feature/auth
</code></pre></div><ol><li>创建<code>auth</code>服务</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate <span class="token function">service</span> feature/auth
OR
$ nest g s feature/auth
</code></pre></div><ol><li>创建<code>auth</code>控制器</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest generate controller feature/auth
OR
$ nest g co feature/auth
</code></pre></div><ol><li>创建<code>auth</code>的<code>dto</code></li></ol> <p>dto是字段参数验证的验证类，需要配合各种功能，等下会讲解。</p> <p>最后完整的<code>auth</code>文件夹是：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>index.ts
auth.module.ts
auth.service.ts
auth.controller.ts
dto
</code></pre></div><blockquote><p>基本所有的<code>feature</code>模块都是这样的结构，后面不在介绍<code>生成文件</code>这项。</p></blockquote> <h3 id="科普知识-async-await"><a href="#科普知识-async-await" class="header-anchor">#</a> 科普知识：async/await</h3> <p><code>ES7</code>发布<code>async/await</code>，也算是异步的解决又一种方案，</p> <p>看一个简单的栗子：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">start</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在这里使用起来就像同步代码那样直观</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">startFor</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前是第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">次等待..</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// startFor();</span>
</code></pre></div><blockquote><p>控制台先输出<code>start</code>，稍等<code>3</code>秒后，输出了<code>end</code>。</p></blockquote> <p>看栗子也能知道<code>async/await</code>基本使用规则和条件</p> <ol><li><code>async</code> 表示这是一个<code>async</code>函数，<code>await</code>只能用在这个函数里面</li> <li><code>await</code> 表示在这里等待<code>promise</code>返回结果了，再继续执行。</li> <li><code>await</code> 等待的虽然是<code>promise</code>对象，但不必写<code>.then(..)</code>，直接可以得到返回值。</li> <li>捕捉错误可以直接用标准的<code>try catch</code>语法捕捉错误</li> <li>循环多个<code>await</code> 可以写在for循环里，不必担心以往需要<code>闭包</code>才能解决的问题 (注意不能使用<code>forEach</code>,只可以用<code>for/for-of</code>)</li></ol> <blockquote><p><strong>注意</strong>：<code>await</code>必须在<code>async</code>函数的上下文中</p></blockquote> <p>在开始之前，前面数据操作有基础服务抽象类，这里控制器和服务也可以抽象出来。是可以抽象出来，但是本项目不决定这么来做，但会做一些抽象的辅助工具。</p> <h3 id="auth模块"><a href="#auth模块" class="header-anchor">#</a> auth模块</h3> <p>auth.module.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入共享模块 访问user数据库</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SharedModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入控制和服务进行在模块注册</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.controller'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        SharedModule<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthController<span class="token punctuation">]</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意</strong>： <code>feature</code> 模块尽量不要导出服务，避免循环依赖。</p></blockquote> <h3 id="feature模块"><a href="#feature模块" class="header-anchor">#</a> feature模块</h3> <p>feature.module.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入Auth模块导入导出</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth/auth.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        AuthModule<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">[</span>
        AuthModule<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FeatureModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意</strong>： <code>feature</code> 模块功能就是导入导出所以的业务模块。</p></blockquote> <h3 id="app模块"><a href="#app模块" class="header-anchor">#</a> app模块</h3> <p>如果是按我顺序用命令行创建的文件，<code>feature</code> 模块会自动添加到 <code>APP</code> 模块里面，
如果不是，需要手动把 <code>feature</code> 模块引入到 <code>APP</code> 模块里面。</p> <p>app.module.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入核心模块 只能在AppModule导入，nest 没有 angular 模块检查机制，只能自觉遵守吧。</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CoreModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./core/core.module'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入特性模块</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FeatureModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'feature'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CoreModule<span class="token punctuation">,</span>
    FeatureModule，
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意</strong>：<code>APP</code> 模块不需要引入 <code>shared</code> 模块，<code>shared</code> 模式给业务模块引用的，<code>APP</code> 模块只需要引入 <code>CoreModule</code>, <code>feature</code> 模块就可以了。</p></blockquote> <h3 id="auth控制器"><a href="#auth控制器" class="header-anchor">#</a> auth控制器</h3> <p>默认控制器文件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="注册"><a href="#注册" class="header-anchor">#</a> 注册</h4> <p>要想登录，就要先注册，那我们先从注册开始。</p> <p>auth.controller.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    Get<span class="token punctuation">,</span>
    Render
 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">)</span>
    @<span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">'auth/register'</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">registerView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> pageTitle<span class="token operator">:</span> <span class="token string">'注册'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前面介绍控制器时候已经介绍了<code>Get</code>，那么<code>Render</code>是什么，渲染模板，对应是<code>Express</code>的<code>res.render('xxxx');</code>方法。</p> <p><strong>提示</strong>：</p> <ol><li>关于控制器方法命名方式，因为本项目是服务的渲染的，所有会有模板页面和页面请求。模板页面统一加上<code>View</code>后缀</li> <li>模板页面请求都是<code>get</code>，返回数据会带一个必须字段<code>pageTitle</code>，当前页面的<code>title</code>标签使用。</li> <li>页面请求方法命名根据实际情况来。</li></ol> <p>现在就可以运行开发启动命令看看效果，百分之两百的会报错，为什么？因为找不到模板<code>auth/register.ejs</code>文件。</p> <p>那我们就去<code>views</code>下去创建一个<code>auth/register.ejs</code>，随便写的什么，在运行就可以了，浏览器访问：<code>http://localhost:3000/register</code>。</p> <p><a href="https://user-images.githubusercontent.com/6111778/50327748-4d4aef80-052b-11e9-8f33-7012966a5f0b.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/50327748-4d4aef80-052b-11e9-8f33-7012966a5f0b.png" alt="2"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>我们需要完善里面的内容了，因为<code>cnode</code>
屏蔽注册功能，全部走<code>github</code>第三方认证登录，所以看不到<code>https://cnodejs.org/signin</code>这个页面，那么我们可以在<a href="https://github.com/cnodejs/egg-cnode/blob/master/app/view/sign/signup.html" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>找到这个页面结构，直接拷贝<code>div#content</code>里的内容过来。</p> <p>一刷新就页面报错了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;statusCode&quot;</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Internal server error&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>查看命令行提示：j</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>Nest<span class="token punctuation">]</span> <span class="token number">22132</span>   - <span class="token number">2018</span>-9-4 <span class="token number">16</span>:21:11   <span class="token punctuation">[</span>ExceptionsHandler<span class="token punctuation">]</span> E:<span class="token punctuation">\</span>github<span class="token punctuation">\</span>nest-cnode<span class="token punctuation">\</span>views<span class="token punctuation">\</span>auth<span class="token punctuation">\</span>register.html:61
    <span class="token number">59</span><span class="token operator">|</span>                         <span class="token operator">&lt;</span>% <span class="token punctuation">}</span> %<span class="token operator">&gt;</span>
    <span class="token number">60</span><span class="token operator">|</span>                     <span class="token operator">&lt;</span>/div<span class="token operator">&gt;</span>
 <span class="token operator">&gt;&gt;</span> <span class="token number">61</span><span class="token operator">|</span>                 <span class="token operator">&lt;</span>/div<span class="token operator">&gt;</span>
    <span class="token number">62</span><span class="token operator">|</span>                 <span class="token operator">&lt;</span>input <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'hidden'</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'_csrf'</span> <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token string">'&lt;%= csrf %&gt;'</span> /<span class="token operator">&gt;</span>
    <span class="token number">63</span><span class="token operator">|</span>
    <span class="token number">64</span><span class="token operator">|</span>                 <span class="token operator">&lt;</span>div <span class="token assign-left variable">class</span><span class="token operator">=</span><span class="token string">'form-actions'</span><span class="token operator">&gt;</span>

csrf is not defined
</code></pre></div><p>提示我们<code>csrf</code>这个变量找不到。<code>csrf</code>是什么，
跨站请求伪造(CSRF或XSRF)是一种恶意利用的网站,未经授权的命令是传播从一个web应用程序的用户信任。
减轻这种攻击可以使用<code>csurf</code>包。这里有篇文章<a href="https://cnodejs.org/topic/5533dd6e9138f09b629674fd" target="_blank" rel="noopener noreferrer">浅谈cnode社区如何防止csrf攻击<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>安装所需的包:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i --save csurf
</code></pre></div><p>在入口文件启动函数里面使用它。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> csurf <span class="token keyword">from</span> <span class="token string">'csurf'</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token comment">// 防止跨站请求伪造</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csurf</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cookie<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>直接这么写肯定有问题，刷新页面控制台报错<code>Error: misconfigured csrf</code></p> <p>下面来说个我经常解决问题方法：</p> <ol><li>首先如果我们用的<code>github</code>的开源依赖包，我们把这个错误复制到它的<code>issues</code>的搜索框里，如果有类似的问题，就进去看看，能不能找到解决方案，如果没有一个问题，你就可以提<code>issues</code>。</li></ol> <p>把你的问题的和环境依赖、最好有示例代码，越详细越好，运气好马上有人给你解决问题。</p> <ol><li>搜索引擎解决问题比如：谷歌、必应、百度。如果有条件首选谷歌，没条件优先必应，其次百度。也是把问题直接复制到输入框，回车就好有一些类似的答案。</li> <li>就是去一些相关社区提问，和<code>1</code>一样，把问题描述清楚。</li></ol> <p>使用必应搜索，发现结果第一个就是问题，和我们一模一样的。</p> <p><a href="https://user-images.githubusercontent.com/6111778/50327760-563bc100-052b-11e9-888d-96abd6977499.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/50327760-563bc100-052b-11e9-888d-96abd6977499.png" alt="3"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>点击链接进去的，有人回复一个收到好评最高，说<code>app.use(csurf())</code>要在<code>app.use(cookieParser())</code>和<code>app.use(session({...})</code>之后执行。</p> <p>其实我们的这个问题，在<a href="https://github.com/expressjs/csurf" target="_blank" rel="noopener noreferrer">csurf<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>说明文档里面已经有写了，使用之前必须依赖<code>cookieParser</code>和<code>session</code>中间件。</p> <p><code>session</code>中间件可以选择<a href="https://www.npmjs.com/package/express-session" target="_blank" rel="noopener noreferrer">express-session<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://www.npmjs.com/package/cookie-session" target="_blank" rel="noopener noreferrer">cookie-session<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>我们需要安装2个中间件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i --save cookie-parser express-session connect-redis
</code></pre></div><p>在入口文件启动函数里面使用它。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> cookieParser <span class="token keyword">from</span> <span class="token string">'cookie-parser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> expressSession <span class="token keyword">from</span> <span class="token string">'express-session'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> connectRedis <span class="token keyword">from</span> <span class="token string">'connect-redis'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> csurf <span class="token keyword">from</span> <span class="token string">'csurf'</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">const</span> RedisStore <span class="token operator">=</span> <span class="token function">connectRedis</span><span class="token punctuation">(</span>expressSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> secret <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'SESSION_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册session中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">expressSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'jiayi'</span><span class="token punctuation">,</span>
    secret<span class="token punctuation">,</span>  <span class="token comment">// 用来对sessionid 相关的 cookie 进行签名</span>
    store<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RedisStore</span><span class="token punctuation">(</span><span class="token function">getRedisConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 本地存储session（文本文件，也可以选择其他store，比如redis的）</span>
    saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否自动保存未初始化的会话，建议false</span>
    resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否每次都重新保存会话，建议false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册cookies中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 防止跨站请求伪造</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csurf</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cookie<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>里面有注释，这里就不解释了。</p> <p>现在刷新还是一样报错<code>csrf is not defined</code>。</p> <p>上面已经ok，现在是没有这个变量，我们去<code>registerView</code>方法返回值里面加上</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token function">registerView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> pageTitle<span class="token operator">:</span> <span class="token string">'注册'</span><span class="token punctuation">,</span> csrf<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>key是<code>csrf</code>，value随便写，返回最后都会被替换的。</p> <p><a href="https://user-images.githubusercontent.com/6111778/50327790-71a6cc00-052b-11e9-84c7-0585c605653a.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/50327790-71a6cc00-052b-11e9-84c7-0585c605653a.png" alt="4"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果每次都要写一个那就比较麻烦了，需要写一个中间件来解决问题。</p> <p>在入口文件启动函数里面使用它。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token comment">// 设置变量 csrf 保存csrfToken值</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>csrf <span class="token operator">=</span> req<span class="token punctuation">.</span>csrfToken <span class="token operator">?</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>在刷新又报了另外一个错误：<code>ForbiddenError: invalid csrf token</code>。验证<code>token</code>失败。</p> <p>文档里面也有，读取令牌从以下位置,按顺序:</p> <ul><li><code>req.body._csrf</code> - typically generated by the <code>body-parser</code> module.</li> <li><code>req.query._csrf</code> - a built-in from Express.js to read from the URL query string.</li> <li><code>req.headers['csrf-token']</code> - the CSRF-Token HTTP request header.</li> <li><code>req.headers['xsrf-token']</code> - the XSRF-Token HTTP request header.</li> <li><code>req.headers['x-csrf-token']</code> - the X-CSRF-Token HTTP request header.</li> <li><code>req.headers['x-xsrf-token']</code> - the X-XSRF-Token HTTP request header.</li></ul> <p>前端向后端提交数据，常用有2种方式，<code>form</code>和<code>ajax</code>。<code>ajax</code>无刷新，这个比较常用，基本是主流操作了。<code>form</code>是服务端渲染使用比较多，不需要js处理直接提交，我们项目大部分都是<code>form</code>直接提交。</p> <p>一般服务端渲染常用就2种请求，<code>get</code>打开一个页面，<code>post</code>直接<code>form</code>提交。</p> <p><code>post</code>提交都是把数据放在<code>body</code>体里面，<code>Express</code>，解析<code>body</code>需要借助中间件<code>body-parser</code>。</p> <p><code>nest</code>已经自带<code>body-parser</code>配置。但是我发现好像有bug，原因不明，给作者提<a href="https://github.com/nestjs/nest/issues/1052" target="_blank" rel="noopener noreferrer">issues<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>作者回复速度很快，需要调用<code>app.init()</code>初始化才行。</p> <p>还有一个重要的东西<code>layout.html</code>模板需要加上<code>csrf</code>这个变量。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>&lt;%= csrf %&gt;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>csrf-token<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>接下来要写表单验证了：</p> <p>我们在<code>dto</code>文件夹里面创建一个<code>register.dto.ts</code>和<code>index.ts</code>文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">touch</span> src/feature/auth/dto/register.dto.ts
$ <span class="token function">touch</span> src/feature/auth/dto/index.ts
OR
编辑器新建文件register.dto.ts
编辑器新建文件index.ts
</code></pre></div><p><code>register.dto.ts</code>是一个导出的类，typescript类型，可以是<code>class</code>，可以<code>interface</code>，推荐<code>class</code>，因为它不光可以定义类型，还可以初始化数据。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RegisterDto</span> <span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> loginname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">readonly</span> email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">readonly</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">readonly</span> re_pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">readonly</span> _csrf<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>什么叫<code>dto</code>, 全称数据传输对象（DTO)(Data Transfer Object)，简单来说<code>DTO</code>是面向界面<code>UI</code>，是通过<code>UI</code>的需求来定义的。通过<code>DTO</code>我们实现了控制器与数据验证转化解耦。</p> <p><code>dto</code>中定义属性就是我们要提交的数据，控制器里面这样获取他们。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">)</span>
@<span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">'auth/register'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">register</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> register<span class="token operator">:</span> RegisterDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样是不是很普通，也没有太大用处。如果真的是这样的，我就不会写出来了。如果我提交数据之前需要验证字段合法性怎么办。<code>nest</code>也为我们想到了，使用官方提供的<code>ValidationPipe</code>，并安装2个必须的依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i --save class-validator class-transformer
</code></pre></div><p>因为数据验证是非常通用的，我们需要在入口文件里全局去注册管道。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">,</span> application<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token comment">// 注册并配置全局验证管道</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    transform<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    whitelist<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    forbidNonWhitelisted<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    skipMissingProperties<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    forbidUnknownValues<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>  
</code></pre></div><blockquote><p>配置信息官网都有介绍，说一个重点，<code>transform</code>是转换数据，配合<code>class-transformer</code>使用。</p></blockquote> <p>开始写验证规则，对于这些装饰器使用方法，可以看文档也可以看<code>.d.ts</code>文件。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
@<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'用户名不能为空'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">Matches</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z0-9\-_]{5, 20}$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'用户名不合法'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">Transform</span><span class="token punctuation">(</span>value <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> toClassOnly<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> loginname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'邮箱不能为空'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">IsEmail</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'邮箱不合法'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">Transform</span><span class="token punctuation">(</span>value <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> toClassOnly<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'密码不能为空'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">IsByteLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'密码长度不是6-18位'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'确认密码不能为空'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> re_pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> _csrf<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><ul><li><code>IsNotEmpty</code>不能为空</li> <li><code>Matches</code>使用正则表达式</li> <li><code>Transform</code>转化数据，这里把英文转成小写。</li></ul> <p>发现一个问题，默认的提供的<code>NotEquals、Equals</code>只能验证一个写死的值，那么我验证确认密码怎么办，这是动态的。我想到一个简单粗暴的方式：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>    @<span class="token function">Transform</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>pass <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">'PASSWORD_INCONSISTENCY'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> toClassOnly<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">NotEquals</span><span class="token punctuation">(</span><span class="token string">'PASSWORD_INCONSISTENCY'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'两次密码输入不一致。'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>先用转化装饰器，去判断，<code>obj</code>拿到就当前实例类，然后去取它对应属性和当前的值对比，如果是相等就直接返回，如果不是就返回一个标识，再用<code>NotEquals</code>去判断。</p> <p>这样写不是很友好，我们需要自定义一个装饰器来完成这个功能。</p> <p>在core新建<code>decorators</code>文件夹下建<code>validator.decorators.ts</code>文件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> registerDecorator<span class="token punctuation">,</span> ValidationOptions<span class="token punctuation">,</span> ValidationArguments<span class="token punctuation">,</span> Validator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">IsEqualsThan</span><span class="token punctuation">(</span>property<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">,</span> validationOptions<span class="token operator">?</span><span class="token operator">:</span> ValidationOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>object<span class="token operator">:</span> object<span class="token punctuation">,</span> propertyName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">registerDecorator</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'IsEqualsThan'</span><span class="token punctuation">,</span>
            target<span class="token operator">:</span> object<span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">,</span>
            propertyName<span class="token punctuation">,</span>
            constraints<span class="token operator">:</span> <span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> validationOptions<span class="token punctuation">,</span>
            validator<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token function">validate</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> args<span class="token operator">:</span> ValidationArguments<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">{</span>
                    <span class="token comment">// 拿到要比较的属性名或者路径 参考`lodash#get`方法</span>
                    <span class="token keyword">const</span> <span class="token punctuation">[</span>comparativePropertyName<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>constraints<span class="token punctuation">;</span>
                    <span class="token comment">// 拿到要比较的属性值</span>
                    <span class="token keyword">const</span> comparativeValue <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>object<span class="token punctuation">,</span> comparativePropertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 返回false 验证失败</span>
                    <span class="token keyword">return</span> validator<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> comparativeValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>官方文字里面有栗子：直接拷贝过来就行了，改改就好。我们需要改的就是<code>name</code>和<code>validate</code>函数里面的内容，</p> <p><code>validate</code>函数返回true验证成功，false验证失败，返回错误消息。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
@<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">'确认密码不能为空'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">IsEqualsThan</span><span class="token punctuation">(</span><span class="token string">'pass'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">'两次密码输入不一致。'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">readonly</span> re_pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><blockquote><p><strong>注意</strong>：<code>IsEqualsThan</code>第一个参数参考[lodash#get(https://lodash.com/docs/4.17.10#get)方法</p></blockquote> <p>验证规则搞定了，现在又有2个新问题了，</p> <ol><li>默认返回全部错误格式是数组json，我们需要格式化自定义错误。</li> <li>我们需要把错误信息显示到当前页面，并且有些字段还需要显示在里面，有些字段不需要（比如密码），需要<code>Render</code>方法，可以实现数据显示，但是拿不到当前错误控制器的模板地址。这个是比较致命的问题，其他问题都好解决。</li></ol> <p>解决这个问题，我纠结了很久，想到了2个方法来解决问题。</p> <h3 id="自定义装饰器-配合validationpipe-httpexceptionfilter实现"><a href="#自定义装饰器-配合validationpipe-httpexceptionfilter实现" class="header-anchor">#</a> 自定义装饰器+配合<code>ValidationPipe</code>+<code>HttpExceptionFilter</code>实现</h3> <p>借助<code>class-validator</code>配置参数的<code>context</code>字段。</p> <p>我们可以在上面写2个字段，一个是<code>render</code>，一个是<code>locals</code>。</p> <p>在实现<code>render</code>功能之前，我们需要借助<code>typescript</code>的一个功能<code>enum</code>枚举。</p> <p><code>Nest</code>里面<code>HttpStatus</code>状态码就是<code>enum</code>。</p> <p>我们把所有的视图模板都存在<code>enum</code>里面，枚举好处就是映射，类似于<code>key-value</code>对象。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// js 模拟 enum 写法</span>
<span class="token keyword">const</span> Enum <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token string">'b'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取值</span>
Enum<span class="token punctuation">[</span>Enum<span class="token punctuation">.</span>a<span class="token punctuation">]</span>
<span class="token comment">// 'a'</span>

<span class="token comment">// 字符串赋值</span>
<span class="token keyword">enum</span> Enum <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
    b <span class="token operator">=</span> <span class="token string">'b'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取值</span>
Enum<span class="token punctuation">.</span>a
<span class="token comment">// 'a'</span>

<span class="token comment">// 索引赋值</span>
<span class="token keyword">enum</span> Enum <span class="token punctuation">{</span>
    a<span class="token punctuation">,</span>
    b
<span class="token punctuation">}</span>

<span class="token comment">// 取值</span>
Enum<span class="token punctuation">.</span>a
<span class="token comment">// 0</span>
</code></pre></div><blockquote><p><code>typescript</code>转成<code>javascript</code>，枚举取值<code>Enum[Enum.a]</code>就是这样的。</p></blockquote> <p>创建视图模板路径枚举</p> <div class="language-ts extra-class"><pre class="language-ts"><code>$ touch src<span class="token operator">/</span>core<span class="token operator">/</span>enums<span class="token operator">/</span>views<span class="token operator">-</span>path<span class="token punctuation">.</span>ts
<span class="token constant">OR</span>
编辑器新建文件views<span class="token operator">-</span>path<span class="token punctuation">.</span>ts
</code></pre></div><p>在里面写上：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">enum</span> ViewsPath <span class="token punctuation">{</span>
    Register <span class="token operator">=</span> <span class="token string">'auth/register'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>auth.controller.ts换上枚举：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">)</span>
@<span class="token function">Render</span><span class="token punctuation">(</span>ViewsPath<span class="token punctuation">.</span>Register<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">register</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> register<span class="token operator">:</span> RegisterDto<span class="token punctuation">,</span> @<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>解决问题之前，我们先看，<code>ValidationPipe</code>源码，验证失败之后干了些什么：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
<span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token keyword">await</span> classValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>validatorOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDetailedOutputDisabled <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> errors<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>返回是一个<code>ValidationError[]</code>，那<code>ValidationError</code>里面有什么：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">ValidationError</span> <span class="token punctuation">{</span>
    target<span class="token operator">?</span><span class="token operator">:</span> Object<span class="token punctuation">;</span> <span class="token comment">// 目标对象，就是我们定义验证规则那个对象。这里是`RegisterDto`</span>
    property<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// 当前字段</span>
    value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>  <span class="token comment">// 当前的值</span>
    constraints<span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">// 验证规则错误提示，我们定义的装饰 @IsNotEmpty,显示的key是 isNotEmpty，value是定义配置里的`message`，定义多少显示多少。如果想一次只显示一个错误怎么办，后面讲怎么处理</span>
        <span class="token punctuation">[</span><span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    children<span class="token operator">:</span> ValidationError<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 嵌套</span>
    contexts<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 装饰器里面配置定义的`context`内容，key是 isNotEmpty ，value是 context内容</span>
        <span class="token punctuation">[</span><span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">toString</span><span class="token punctuation">(</span>shouldDecorate<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> hasParent<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> parentPath<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// 这玩意就不解释了。</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最开始我想到是使用<code>context</code>来配置3个字段：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// context定义内容</span>
<span class="token keyword">interface</span> <span class="token class-name">context</span> <span class="token punctuation">{</span>
    render<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>  <span class="token comment">// 视图模板路径</span>
    locals<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> <span class="token comment">// 字段是否显示</span>
    priority<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>  <span class="token comment">// 验证规则显示优先级</span>
<span class="token punctuation">}</span>

<span class="token comment">// Render需要参数</span>
<span class="token keyword">interface</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
    view<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>  <span class="token comment">// 视图模板路径</span>
    locals<span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">// 模板显示的变量</span>
        error<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>   <span class="token comment">// 必须有的错误消息</span>
        <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>折腾一遍，功能实现了，就是太麻烦了。每个规则验证装饰器里面都要写<code>context</code>一坨。</p> <p>能不能简便一点了。如果我在这个类里面只定义一次是不是好点。</p> <p>就想到了在<code>RegisterDto</code>里写个私有属性，把相关的字段存进去，改进了<code>context</code>配置：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ValidatorFilterContext</span> <span class="token punctuation">{</span>
    render<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    locals<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    priority<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就变成这样的：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>

__validator_filter__<span class="token operator">:</span> <span class="token punctuation">{</span>
    render<span class="token operator">:</span> ViewsPath<span class="token punctuation">.</span>Register<span class="token punctuation">,</span>
    locals<span class="token operator">:</span> <span class="token punctuation">{</span>
        loginname<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        pass<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        re_pass<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        email<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    priority<span class="token operator">:</span> <span class="token punctuation">{</span>
        loginname<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'IsNotEmpty'</span><span class="token punctuation">,</span> <span class="token string">'Matches'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        pass<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'IsNotEmpty'</span><span class="token punctuation">,</span> <span class="token string">'IsByteLength'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        re_pass<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'IsNotEmpty'</span><span class="token punctuation">,</span> <span class="token string">'IsEqualsThan'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        email<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'IsNotEmpty'</span><span class="token punctuation">,</span> <span class="token string">'IsEmail'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>这样就比每个规则验证装饰器写<code>context</code>配置好了很多，但是这样又有一个问题，会在<code>target</code>里面多一个<code>__validattsor_filter__</code>，有点多余了。</p> <p>需要改进一下，我就想到类装饰器。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">VALIDATOR_FILTER</span> <span class="token operator">=</span> <span class="token string">'__validator_filter__'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ValidatorFilter</span><span class="token punctuation">(</span>context<span class="token operator">:</span> ValidatorFilterContext<span class="token punctuation">)</span><span class="token operator">:</span> ClassDecorator <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token constant">VALIDATOR_FILTER</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>类装饰器前面已经说过了，它是装饰器里面最后执行的，用来装饰类。这里有个比较特殊的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect" target="_blank" rel="noopener noreferrer">Reflect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><code>Reflect</code>翻译叫反射，应该说叫映射靠谱点。为什么了，它基本就是类似此功能。</p> <p><code>defineMetadata</code>定义元数据，有3个参数：第一个是标识key，第二个是存储的数据（获取就是它），第三个就是一个对象。</p> <p>翻译过来就是在 a 对象里面定一个标识 b 的数据为c。有定义就有获取</p> <p><code>getMetadata</code>获取元数据，有2个参数：第一个是标识key，第三个就是一个对象。</p> <p>翻译过来就是在 a 对象里去查一个b 标识，如果有就返回原数据，如果没有就是Undefined。或者是b标识里面去查找a对象。理解差不多。目的是2个都匹配就返回数据。</p> <p>这玩意简单理解<code>Reflect</code>是一个全局对象，<code>defineMetadata</code>定一个特定标识的数据，<code>getMetadata</code>根据特定标识获取数据。这里<code>Reflect</code>用的比较简单就不深入了，<code>Reflect</code>是<code>es6</code>新特性一部分。</p> <p>在<code>Nest</code>的装饰器大量使用<code>Reflect</code>。在<code>nodejs</code>使用，需要借助<code>reflect-metadata</code>，引入方式<code>import 'reflect-metadata';</code>。</p> <p>处理完了，dot问题，那么我们接下来要处理异常捕获过滤器问题了。</p> <p>前面也说，<code>Nest</code>执行顺序：<code>客户端请求 ---&gt; 中间件 ---&gt; 守卫 ---&gt; 拦截器之前 ---&gt; 管道 ---&gt; 控制器处理并响应 ---&gt; 拦截器之后 ---&gt; 过滤器</code>。</p> <p>因为<code>ValidationPipe</code>源码里，只要验证错误就直接抛异常<code>new BadRequestException()</code>，然后就直接跳过控制器处理并响应，走拦截器之后和过滤器了。</p> <p>那么我们需要在过滤器来处理这些问题，这是为什么要这么麻烦原因。</p> <p><code>Nest</code>已经提供一个自定义<code>HttpExceptionFilter</code>的栗子，我们需要改良一下这个栗子。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Catch</span><span class="token punctuation">(</span>HttpException<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HttpExceptionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionFilter</span> <span class="token punctuation">{</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token operator">:</span> HttpException<span class="token punctuation">,</span> host<span class="token operator">:</span> ArgumentsHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> response<span class="token operator">:</span> Response  <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> request<span class="token operator">:</span> Request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> status <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果错误码 400</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> HttpStatus<span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">validationErrorMessage</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span>message<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>render<span class="token punctuation">.</span>view<span class="token punctuation">,</span> render<span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>render</code>接受3个参数，平常只用前个，第一个是模板路径或者模板，第二个提供给模板显示的数据。</p> <p>这里核心地方在<code>validationErrorMessage</code>里：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">validationErrorMessage</span><span class="token punctuation">(</span>messages<span class="token operator">:</span> ValidationError<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Render <span class="token punctuation">{</span>
    <span class="token keyword">const</span> message<span class="token operator">:</span> ValidationError <span class="token operator">=</span> messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> metadata<span class="token operator">:</span> ValidatorFilterContext <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token constant">VALIDATOR_FILTER</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'context is not undefined, use @ValidatorFilter(context)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理错误消息显示</span>
    <span class="token keyword">const</span> priorities <span class="token operator">=</span> metadata<span class="token punctuation">.</span>priority<span class="token punctuation">[</span>message<span class="token punctuation">.</span>property<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> notFound <span class="token operator">=</span> priorities<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\b(\w)(\w*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">,</span> $<span class="token number">1</span><span class="token punctuation">,</span> $<span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> $<span class="token number">1.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> $<span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>message<span class="token punctuation">.</span>constraints<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> message<span class="token punctuation">.</span>constraints<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 没有找到对应错误消息，取第一个</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>notFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> message<span class="token punctuation">.</span>constraints<span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>constraints<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理错误以后显示数据</span>
    <span class="token keyword">const</span> locals <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>locals<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> message<span class="token punctuation">.</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        view<span class="token operator">:</span> metadata<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
        locals<span class="token operator">:</span> <span class="token punctuation">{</span>
            error<span class="token punctuation">,</span>
            <span class="token operator">...</span>locals<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>我们拿到的<code>messages</code>是一个数组，我们每次只显示一个错误消息，总是取第一个即可</li> <li><code>metadata</code>是我们根据标识获取的元数据，如果找不到，就抛出异常。<strong>注意</strong>：<code>message.target</code>是一个<code>{}</code>，我们需要获取它的<code>constructor</code>才行。</li> <li><code>priorities</code>获取当前错误字段显示错误提取的优先级列表</li> <li><code>priority</code>里面没有配置获取配置<code>[]</code>, 就直接返回验证规则第一个。<strong>提示</strong>：这也是<code>{}</code>坑，默认按字母顺序排列属性的位置。</li> <li><code>locals</code>直接去判断配置的<code>locals</code>，哪些<code>key</code>可以显示哪些<code>key</code>不能显示。</li> <li>最后数据拼装在一起返回，供<code>render</code>使用。</li></ul> <h3 id="自定义装饰器-自定义viewvalidationpipe实现"><a href="#自定义装饰器-自定义viewvalidationpipe实现" class="header-anchor">#</a> 自定义装饰器+自定义<code>ViewValidationPipe</code>实现</h3> <p>装饰器部分就不用说了，和上面一样，虽然不需要但是后面有用。</p> <p><code>ViewValidationPipe</code>实现：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> ArgumentMetadata<span class="token punctuation">,</span> PipeTransform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> classTransformer <span class="token keyword">from</span> <span class="token string">'class-transformer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> classValidator <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ValidatorOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common/interfaces/external/validator-options.interface'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> isNil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ValidationError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">VALIDATOR_FILTER</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../constants/validator-filter.constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ValidatorFilterContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../decorators'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ValidationPipeOptions</span> <span class="token keyword">extends</span> <span class="token class-name">ValidatorOptions</span> <span class="token punctuation">{</span>
    transform<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    disableErrorMessages<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ViewValidationPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> isTransformEnabled<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> isDetailedOutputDisabled<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> validatorOptions<span class="token operator">:</span> ValidatorOptions<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>@<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> options<span class="token operator">?</span><span class="token operator">:</span> ValidationPipeOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            transform<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            whitelist<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            forbidNonWhitelisted<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            skipMissingProperties<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            forbidUnknownValues<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> transform<span class="token punctuation">,</span> disableErrorMessages<span class="token punctuation">,</span> <span class="token operator">...</span>validatorOptions <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isTransformEnabled <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>transform<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validatorOptions <span class="token operator">=</span> validatorOptions<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isDetailedOutputDisabled <span class="token operator">=</span> disableErrorMessages<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> metadata<span class="token operator">:</span> ArgumentMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> metatype <span class="token punctuation">}</span> <span class="token operator">=</span> metadata<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metatype <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toValidate</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> entity <span class="token operator">=</span> classTransformer<span class="token punctuation">.</span><span class="token function">plainToClass</span><span class="token punctuation">(</span>
            metatype<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toEmptyIfNil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token keyword">await</span> classValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>validatorOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重点实现 start</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">validationErrorMessage</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">.</span>locals<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 重点实现 end</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isTransformEnabled
            <span class="token operator">?</span> entity
            <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validatorOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">?</span> classTransformer<span class="token punctuation">.</span><span class="token function">classToPlain</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
                <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">toValidate</span><span class="token punctuation">(</span>metadata<span class="token operator">:</span> ArgumentMetadata<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> metatype<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token punctuation">}</span> <span class="token operator">=</span> metadata<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> <span class="token string">'custom'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> <span class="token builtin">Array</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> metatype <span class="token operator">===</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isNil</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token generic-function"><span class="token function">toEmptyIfNil</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">R</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isNil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们这里把<code>validationErrorMessage</code>函数直接拿过来了。</p> <p>控制器就需要这么写：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">)</span>
@<span class="token function">Render</span><span class="token punctuation">(</span>ViewsPath<span class="token punctuation">.</span>Register<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">register</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ViewValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    transform<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    whitelist<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    forbidNonWhitelisted<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    skipMissingProperties<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    forbidUnknownValues<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> register<span class="token operator">:</span> RegisterDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>register <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> register<span class="token punctuation">.</span>locals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>拿到是<code>pipe</code>转换后的结果</li> <li>如果有<code>view</code>表示出错了，就直接返回<code>locals</code>，如果没有就接着处理服务逻辑。</li></ul> <p><strong>注意</strong>：<code>(register as any).view</code>这个<code>view</code>是不靠谱的，需要返回一个特殊标识，不然页面出现一个<code>view</code>字段，就挂了。</p> <p>这里我们使用第一种，接着实现服务逻辑。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
<span class="token keyword">async</span> <span class="token function">register</span><span class="token punctuation">(</span>register<span class="token operator">:</span> RegisterDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> loginname<span class="token punctuation">,</span> email <span class="token punctuation">}</span> <span class="token operator">=</span> register<span class="token punctuation">;</span>
    <span class="token comment">// 检查用户是否存在，查询登录名和邮箱</span>
    <span class="token keyword">const</span> exist <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        $or<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> loginname <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> email <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回1存在，0不存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            error<span class="token operator">:</span> <span class="token string">'用户名或邮箱已被使用。'</span><span class="token punctuation">,</span>
            loginname<span class="token punctuation">,</span>
            email<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// hash加密密码，不能明文存储到数据库</span>
    <span class="token keyword">const</span> passhash <span class="token operator">=</span> <span class="token function">hashSync</span><span class="token punctuation">(</span>register<span class="token punctuation">.</span>pass<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 错误捕获 async/await 科普已经说明</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保存用户到数据库</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loginname<span class="token punctuation">,</span> email<span class="token punctuation">,</span> pass<span class="token operator">:</span> passhash <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 预留发送激活邮箱实现</span>

        <span class="token comment">// 返回注册成功信息</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            success<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">欢迎加入 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Config<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">！我们已给您的注册邮箱发送了一封邮件，请点击里面的链接来激活您的帐号。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalServerErrorException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>里面注释也说明的我们要操作的步骤，注册逻辑还是比较简单：</p> <ul><li>验证参数是否合法</li> <li>查询用户是否注册</li> <li>加密密码</li> <li>保存到数据库</li> <li>发送激活邮箱</li> <li>返回注册成功信息</li></ul> <p>做登录之前完成邮箱激活的功能。</p> <h3 id="邮箱模块"><a href="#邮箱模块" class="header-anchor">#</a> 邮箱模块</h3> <p>前面基础已经介绍过<code>nest</code>模块，这里邮箱模块是一个通用的功能模块，我们需要抽离出来写成可配置的动态模块。<code>nest</code>目前没有提供发邮箱的功能模块，我们只能自己动手写了，<code>nodejs</code>发送邮件最出名使用<a href="https://nodemailer.com/about/" target="_blank" rel="noopener noreferrer">node-mailer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。我们这里也把<code>node-mailer</code>封装一下。</p> <p>对于一个没有写过动态模块的我，是一脸懵逼，还好作者写很多包装的功能模块：</p> <ul><li>graphql</li> <li>typeorm</li> <li>terminus</li> <li>passport</li> <li>elasticsearch</li> <li>mongoose</li> <li>jwt</li> <li>cqrs</li></ul> <p>既然不会写我们可以copy一个来仿写，实现我们要功能就ok了，卷起袖子就是干。</p> <p>通过观察上面几个模块他们文件结构都是这样的：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>index<span class="token punctuation">.</span>ts  <span class="token comment">// 导出快捷文件</span>
mailer<span class="token operator">-</span>options<span class="token punctuation">.</span><span class="token keyword">interface</span><span class="token punctuation">.</span>ts  <span class="token comment">// 定义配置接口</span>
mailer<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>ts  <span class="token comment">// 定义常量</span>
mailer<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>ts  <span class="token comment">// 定义供应商</span>
mailer<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>ts     <span class="token comment">// 定义导出模块</span>
mailer<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>ts  <span class="token comment">// 定义装饰器</span>
</code></pre></div><p>我们也来新建一个这样的结构，<code>core/mailer</code>建文件就不说了。</p> <p>这一个模块，就需要先从模块开始：</p> <ul><li>动态可配置模块，而且还是全局模块，只需要导入一次即可。</li> <li>同步配置可以是直接填写，异步配置可以是依赖其他模块</li></ul> <p>这是我们要实现的2个重要功能，作者写的模块基本是这个套路，有些东西我们不会写，可以先模仿。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> DynamicModule<span class="token punctuation">,</span> Module<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> Global <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MailerModuleAsyncOptions<span class="token punctuation">,</span> MailerOptionsFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mailer-options.interface'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MailerService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mailer.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">MAILER_MODULE_OPTIONS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mailer.constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createMailerClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mailer.provider'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MailerModule</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 同步引导邮箱模块
     * @param options 邮箱模块的选项
     */</span>
    <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> DynamicModule <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token keyword">module</span><span class="token operator">:</span> MailerModule<span class="token punctuation">,</span>
            providers<span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">MAILER_MODULE_OPTIONS</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> options <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token generic-function"><span class="token function">createMailerClient</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                MailerService<span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            exports<span class="token operator">:</span> <span class="token punctuation">[</span>MailerService<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 异步引导邮箱模块
     * @param options 邮箱模块的选项
     */</span>
    <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">forRootAsync</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>options<span class="token operator">:</span> MailerModuleAsyncOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> DynamicModule <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token keyword">module</span><span class="token operator">:</span> MailerModule<span class="token punctuation">,</span>
            imports<span class="token operator">:</span> options<span class="token punctuation">.</span>imports <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            providers<span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAsyncProviders</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token generic-function"><span class="token function">createMailerClient</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                MailerService<span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            exports<span class="token operator">:</span> <span class="token punctuation">[</span>MailerService<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>forRoot</code>配置同步模块</li> <li><code>forRootAsync</code>配置异步模块</li></ul> <p>我们先说和<code>node-mailer</code>相关的，<code>node-mailer</code>主要分2块：</p> <ul><li>创建<code>node-mailer</code>实例，<code>node-mailer</code>新版解决很多问题，自动去识别不同邮件配置，这对我们来说是一个非常好的消息，不用去做各种适配配置了，只需要按官网的相关配置即可。</li> <li>使用<code>node-mailer</code>实例，<code>set</code>设置配置和<code>use</code>注册插件，<code>sendMail</code>发送邮件</li></ul> <p>创建在<code>createMailerClient</code>方法里面完成</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">MAILER_MODULE_OPTIONS</span><span class="token punctuation">,</span> <span class="token constant">MAILER_TOKEN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mailer.constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createTransport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nodemailer'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createMailerClient <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">MAILER_TOKEN</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createTransport</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">MAILER_MODULE_OPTIONS</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个方法是一个工厂方法，在介绍这个方法之前，先要回顾一下，<code>nest</code>依赖注入自定义服务：</p> <ul><li>Use value</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> connectionProvider <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token string">'Connection'</span><span class="token punctuation">,</span>
  useValue<span class="token operator">:</span> connection<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>值服务：这个一般作为配置，定义全局常量使用，单纯<code>key-value</code>形式</p> <ul><li>Use class</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> configServiceProvider <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> ConfigService<span class="token punctuation">,</span>
  useClass<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
    <span class="token operator">?</span> DevelopmentConfigService
    <span class="token operator">:</span> ProductionConfigService<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>类服务：这个比较常用，默认就是类服务，如果<code>provide</code>和<code>useClass</code>一样，直接注册在<code>providers</code>数组里即可。我们只关心<code>provide</code>注入是谁，不关心<code>useClass</code>依赖谁。</p> <ul><li>Use factory</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> connectionFactory <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token string">'Connection'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>optionsProvider<span class="token operator">:</span> OptionsProvider<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> optionsProvider<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DatabaseConnection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span>OptionsProvider<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>工厂服务：这个比较高级，一般需要依赖其他服务，来创建当前服务的时候，操作使用。定制服务经常用到。</p> <p>我们在回过头来说上面这个<code>createMailerClient</code>方法</p> <p>本来我们可以直接写出一个<code>Use factory</code>例子一样的，考虑它需要<code>forRoot</code>和<code>forRootAsync</code>都需要使用，我们写成一个函数，使用时候直接调用即可，也可以写成一个对象形式。</p> <p><code>provide</code>引入我们定义的常量，至于这个常量是什么，我们不需要关心，如果它变化这个注入者也发生变化，这里不需要改任何代码。也算是配置和程序分离，一种比较好编程方式。</p> <p><code>inject</code>依赖其他服务，这里依赖是一个<code>useValue</code>服务，我们把邮箱配置传递给<code>MAILER_MODULE_OPTIONS</code>，然后把它放到<code>inject</code>，这样我们在<code>useFactory</code>方法里面就可以取到依赖列表。</p> <p><strong>注意</strong>：<code>inject</code>是一个数组，<code>useFactory</code>参数和<code>inject</code>一一对应，简单理解，<code>useFactory</code>是形参，<code>inject</code>数组是实参。</p> <p>在<code>useFactory</code>里面，我们可以根据参数做相关的操作，这里我们直接获取这个服务即可，然后使用<code>nodemailer</code>提供的邮件创建方法<code>createTransport</code>即可。</p> <p>依赖注入和服务重点，我不关心依赖者怎么处理，我只关心注入者给我提供什么。</p> <p>我们在来说上面这个<code>MAILER_MODULE_OPTIONS</code>值服务</p> <p><code>MAILER_MODULE_OPTIONS</code>在<code>forRoot</code>里是一个值服务<code>{ provide: MAILER_MODULE_OPTIONS, useValue: options }</code>，保存传递的参数。
<code>MAILER_MODULE_OPTIONS</code>在<code>forRootAsync</code>里是一个特殊处理<code>...this.createAsyncProviders(options)</code>，后面会讲解这个函数。</p> <p><strong>注意</strong>：因为<code>createMailerClient</code>依赖它，所以一定要在<code>createMailerClient</code>方法完成注册。</p> <p>说完通用的创建服务，来说<code>forRootAsync</code>里的<code>createAsyncProviders</code>方法：</p> <p><code>createAsyncProviders</code>主要完成的工作是把邮箱配置和邮箱动态模块配置剥离开来，然后根据给定要求分别去处理。</p> <p><code>createAsyncProviders</code>方法</p> <div class="language-ts extra-class"><pre class="language-ts"><code>    <span class="token comment">/**
     * 根据给定的模块选项返回异步提供程序
     * @param options 邮箱模块的选项
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">createAsyncProviders</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        options<span class="token operator">:</span> MailerModuleAsyncOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>useFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createAsyncOptionsProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAsyncOptionsProvider</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                provide<span class="token operator">:</span> options<span class="token punctuation">.</span>useClass<span class="token punctuation">,</span>
                useClass<span class="token operator">:</span> options<span class="token punctuation">.</span>useClass<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据给定的模块选项返回异步邮箱选项提供程序
     * @param options 邮箱模块的选项
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">createAsyncOptionsProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        options<span class="token operator">:</span> MailerModuleAsyncOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> Provider <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>useFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                provide<span class="token operator">:</span> <span class="token constant">MAILER_MODULE_OPTIONS</span><span class="token punctuation">,</span>
                useFactory<span class="token operator">:</span> options<span class="token punctuation">.</span>useFactory<span class="token punctuation">,</span>
                inject<span class="token operator">:</span> options<span class="token punctuation">.</span>inject <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            provide<span class="token operator">:</span> <span class="token constant">MAILER_MODULE_OPTIONS</span><span class="token punctuation">,</span>
            <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>optionsFactory<span class="token operator">:</span> MailerOptionsFactory<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> optionsFactory<span class="token punctuation">.</span><span class="token function">createMailerOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inject<span class="token operator">:</span> <span class="token punctuation">[</span>options<span class="token punctuation">.</span>useClass<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>解释这个函数之前，先看配置参数有接口：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">MailerModuleAsyncOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Pick<span class="token operator">&lt;</span>ModuleMetadata<span class="token punctuation">,</span> <span class="token string">'imports'</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 模块的名称
     */</span>
    name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 应该用于提供MailerOptions的类
     */</span>
    useClass<span class="token operator">?</span><span class="token operator">:</span> Type<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 工厂应该用来提供MailerOptions
     */</span>
    useFactory<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 应该注入的提供者
     */</span>
    inject<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里面支持2种写法，一种是自定义类，然后使用<code>useClass</code>, 一种是自定义工厂，然后使用<code>useFactory</code>。</p> <p>使用在<code>MailerService</code>服务里面完成并且把它导出给其他模块使用</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Inject<span class="token punctuation">,</span> Injectable<span class="token punctuation">,</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">MAILER_TOKEN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mailer.constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Mail <span class="token keyword">from</span> <span class="token string">'nodemailer/lib/mailer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Options <span class="token keyword">as</span> MailMessageOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nodemailer/lib/mailer'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">from</span><span class="token punctuation">,</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> tap<span class="token punctuation">,</span> retryWhen<span class="token punctuation">,</span> scan<span class="token punctuation">,</span> delay <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span><span class="token string">'MailerModule'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MailerService</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">MAILER_TOKEN</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> mailer<span class="token operator">:</span> Mail<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token comment">// 注册插件</span>
    <span class="token function">use</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function-variable function">pluginFunc</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> ThisType<span class="token operator">&lt;</span>MailerService<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mailer<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pluginFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置配置</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> ThisType<span class="token operator">&lt;</span>MailerService<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mailer<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送邮件配置</span>
    <span class="token keyword">async</span> <span class="token function">send</span><span class="token punctuation">(</span>mailMessage<span class="token operator">:</span> MailMessageOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mailer<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>mailMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">handleRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'send mail success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mailer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">handleRetry</span><span class="token punctuation">(</span>
    retryAttempts <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    retryDelay <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>source<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>source<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> source<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
        <span class="token function">retryWhen</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span>
            e<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
                <span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>errorCount<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unable to connect to the database. Retrying (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errorCount <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;=</span> retryAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'send mail finally error'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> errorCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">delay</span><span class="token punctuation">(</span>retryDelay<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@Inject</code>是一个注入器，接受一个<code>provide</code>标识、令牌，这里我们拿到了<code>node-mailer</code>实例</p> <p><code>send</code>方法使用<code>rxjs</code>写法，<code>this.mailer.sendMail(mailMessage)</code>返回是一个<code>Promise</code>，<code>Promise</code>有一些缺陷，<code>rxjs</code>可以去弥补一下这些缺陷。</p> <p>比如这里使用是rxjs作用就是，<code>handleRetry()</code>去判断发送有没有错误，如果有错误，就去重试，默认重试5次，如果还错误就直接抛出异常。<code>tap()</code>类似一个<code>console</code>，不会去改变数据流。
有2个参数，第一个是无错误的处理函数，第二个是有错误的处理函数。如果发送成功我们需要关闭连接。<code>toPromise</code>就更简单了，看名字也知道，把<code>rxjs</code>转成<code>Promise</code>。</p> <p>介绍完这个这个模块，那么接下来要说一下怎么使用它们：</p> <p>模块注册：我们需要在核心模块里面<code>imports</code>，因为邮件需要一些配置信息，比如邮件地址，端口号，发送邮件的用户和授权码，如果不知道邮箱配置可<a href="https://nodemailer.com/about/" target="_blank" rel="noopener noreferrer">参考nodemailer官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>MailerModule<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRootAsync</span><span class="token generic class-name"><span class="token operator">&lt;</span>SMTPTransportOptions<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mailer <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'MAIL_HOST'</span><span class="token punctuation">,</span> <span class="token string">'MAIL_PORT'</span><span class="token punctuation">,</span> <span class="token string">'MAIL_USER'</span><span class="token punctuation">,</span> <span class="token string">'MAIL_PASS'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            host<span class="token operator">:</span> mailer<span class="token punctuation">.</span><span class="token constant">MAIL_HOST</span><span class="token punctuation">,</span>     <span class="token comment">// 邮箱smtp地址</span>
            port<span class="token operator">:</span> mailer<span class="token punctuation">.</span><span class="token constant">MAIL_PORT</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 端口号</span>
            secure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            secureConnection<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            auth<span class="token operator">:</span> <span class="token punctuation">{</span>
                user<span class="token operator">:</span> mailer<span class="token punctuation">.</span><span class="token constant">MAIL_USER</span><span class="token punctuation">,</span>  <span class="token comment">// 邮箱账号</span>
                pass<span class="token operator">:</span> mailer<span class="token punctuation">.</span><span class="token constant">MAIL_PASS</span><span class="token punctuation">,</span>  <span class="token comment">// 授权码</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            ignoreTLS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    inject<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><p>先使用注入依赖<code>ConfigService</code>，拿到配置服务，根据配置服务获取对应的配置。进行邮箱配置即可。</p> <p>在页面怎么使用它们，因为本项目比较简单，只有2个地方需要使用邮箱，注册成功和找回密码时候，单独写一个<code>mail.services</code>服务去处理它们，并且模板里面内容除了用户名，token等特定的数据是动态的，其他都是写死的。</p> <p>mail.services</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * 激活邮件
 * @param to 激活人邮箱
 * @param token token
 * @param username 名字
 */</span>
<span class="token function">sendActiveMail</span><span class="token punctuation">(</span>to<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">社区帐号激活</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;您好：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
        &lt;p&gt;我们收到您在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">社区的注册信息，请点击下面的链接来激活帐户：&lt;/p&gt;
        &lt;a href=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/active_account?key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;激活链接&lt;/a&gt;
        &lt;p&gt;若您没有在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">社区填写过注册信息，说明有人滥用了您的电子邮箱，请删除此邮件，我们对给您造成的打扰感到抱歉。&lt;/p&gt;
        &lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">社区 谨上。&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mailer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token keyword">from</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
        subject<span class="token punctuation">,</span>
        html<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里是实现激活邮件方法，前面写的<code>mailer</code>模块，服务里面提供的<code>send</code>方法，接受四个最基本的参数。</p> <ul><li><code>this.name</code>是配置里面获取的<code>name</code></li> <li><code>this.from</code>是配置里面获取的数据，拼接而成，具体看源码</li> <li><code>this.host</code>是配置里面获取的数据，拼接而成，具体看源码</li> <li><code>from</code>邮件发起者，<code>to</code>邮件接收者，<code>subject</code>显示在邮件列表的标题，<code>html</code>邮件内容。</li></ul> <p>我们在注册成功时候直接去调用它就好了。</p> <p><strong>注意</strong>：我在本地测试，使用163邮箱作为发送者，用qq注册，就会被拦截，出现在垃圾邮箱里面。</p> <h3 id="验证注册邮箱"><a href="#验证注册邮箱" class="header-anchor">#</a> 验证注册邮箱</h3> <p>我们实现了发现邮箱的功能，接下来就来尝试验证走注册的功能及验证邮箱验证完成注册。</p> <p>因为我只要一个发送邮箱的账号，和一个测试邮箱的的账号，我需要去数据库把我之前注册的账号删除了，从新完成注册。</p> <p>填写信息，点击注册，就会发送一封邮件，是这个样子的：</p> <p><a href="https://user-images.githubusercontent.com/6111778/56122270-a04a2600-5fa4-11e9-9df1-82a32a593217.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/56122270-a04a2600-5fa4-11e9-9df1-82a32a593217.png" alt="I1A1)WG%(TW 532FZ)(AME9"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>点击<code>激活链接</code>链接跳回来激活账号：</p> <p><a href="https://user-images.githubusercontent.com/6111778/56122344-ce2f6a80-5fa4-11e9-84f9-93747d625a86.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/56122344-ce2f6a80-5fa4-11e9-84f9-93747d625a86.png" alt="2BAJ14WL_L}K{Z GZE{Q7`2"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>接下来我们就来实现<code>active_account</code>路由的逻辑</p> <p>创建一个<code>account.dto</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">ValidatorFilter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    render<span class="token operator">:</span> ViewsPath<span class="token punctuation">.</span>Notify<span class="token punctuation">,</span>
    locals<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        key<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    priority<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'IsNotEmpty'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        key<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'IsNotEmpty'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AccountDto</span> <span class="token punctuation">{</span>
    @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'name不能为空'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    @<span class="token function">Transform</span><span class="token punctuation">(</span>value <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> toClassOnly<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'key不能为空'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">readonly</span> key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个很简单理解：需要2个参数，一个name，一个key，name是用户名，key是注册时候我们创建的标识，邮箱，密码，自定义盐混合一起加密。</p> <p>通用消息模板：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token function">layout</span><span class="token punctuation">(</span><span class="token string">'layout'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">%</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>article id<span class="token operator">=</span><span class="token string">&quot;content&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'panel'</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'header'</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'breadcrumb'</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">'/'</span><span class="token operator">&gt;</span>主页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'divider'</span><span class="token operator">&gt;</span><span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'active'</span><span class="token operator">&gt;</span>通知<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'inner'</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> error <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;alert alert-error&quot;</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>strong<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> error <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> success <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> success<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;alert alert-success&quot;</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>strong<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> success <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;&lt;%- typeof referer !== 'undefined' ? referer : '/' %&gt;&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;span-common&quot;</span><span class="token operator">&gt;</span>返回<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>article<span class="token operator">&gt;</span>
</code></pre></div><p>这模板直接拿<code>cnode</code>的页面。</p> <p>接下来就是控制器：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> authService<span class="token operator">:</span> AuthService<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token comment">/** 激活账号 */</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/active_account'</span><span class="token punctuation">)</span>
    @<span class="token function">Render</span><span class="token punctuation">(</span>ViewsPath<span class="token punctuation">.</span>Notify<span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">activeAccount</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> account<span class="token operator">:</span> AccountDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">activeAccount</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们需要获取<code>url</code>的<code>?</code>后面的参数，需要用到<code>@Query()</code>装饰器，配合参数验证，最后拿到数据参数，丢给对应的服务去处理业务逻辑。</p> <p><a href="https://github.com/Injectable" target="_blank" rel="noopener noreferrer">@Injectable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>()
export class AuthService {
private readonly logger = new Logger(AuthService.name, true);
constructor(
private readonly userService: UserService,
private readonly config: ConfigService,
private readonly mailService: MailService,
) { }
...</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/** 激活账户 */</span>
<span class="token keyword">async</span> <span class="token function">activeAccount</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> key <span class="token punctuation">}</span><span class="token operator">:</span> AccountDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        loginname<span class="token operator">:</span> name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检查用户是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">'用户不存在'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对比key是否正确</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> utility<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email <span class="token operator">+</span> user<span class="token punctuation">.</span>pass <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'SESSION_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">'信息有误，帐号无法被激活。'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 检查用户是否激活过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">'帐号已经是激活状态。'</span><span class="token punctuation">,</span> referer<span class="token operator">:</span> <span class="token string">'/login'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果没有激活，就激活操作</span>
    user<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token string">'帐号已被激活，请登录'</span><span class="token punctuation">,</span> referer<span class="token operator">:</span> <span class="token string">'/login'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>}</p> <p>注释已经写的很清晰的，就不在叙述的问题。接下来讲我们这篇文章的最后一个问题登录，在讲到登录之前需要简单科普一下怎么才算登录，它的凭证是什么？</p> <h2 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h2> <h3 id="登录凭证"><a href="#登录凭证" class="header-anchor">#</a> 登录凭证</h3> <p>目前来说比较常用有2种一种是<code>session+cookie</code>，一种是<code>JSON Web Tokens</code>。</p> <h4 id="session-cookie"><a href="#session-cookie" class="header-anchor">#</a> session+cookie</h4> <p>session+cookie是比较常见前后端一起那种。它是流程大概是这样的：</p> <ol><li>前端发起 http 请求时有携带 cookie</li> <li>后端拿到此 cookie 对比服务器 session，有登陆则放过此请求，无登录，redirect 到登录页面</li> <li>前端登录，后端比对用户名密码，成功则生成唯一标识符，放在 session，并且存入浏览器 cookie</li> <li>用户可以拿到自己的 cookie，就可以发起任何的客户端 http 请求</li></ol> <p>注意：以上操作都是合法操作，如果个人过失暴露 cookie 给其他人，属于用户个人的行为，比如你在网吧里登录 QQ，服务端没有办法不允许这样操作。而客户端的人应有安全意识，在公共场所及时清空 cookie，或者停止使用一切 [不随 session 关闭而 cookie 失效] 的应用。</p> <h4 id="json-web-tokens"><a href="#json-web-tokens" class="header-anchor">#</a> JSON Web Tokens</h4> <p>JSON Web Tokens是比较常见前后分离那种。它是流程大概是这样的：</p> <ol><li>登录时候,客户端通过用户名与密码请求登录</li> <li>服务端收到请求区验证用户名与密码</li> <li>验证通过,服务端会签发一个Token,再把这个Token发给客户端.</li> <li>客户端收到Token,存储到本地,如Cookie,SessionStorage,LocalStorage.</li> <li>客户端每次像服务器请求API接口时候,都要带上Token.</li> <li>服务端收到请求,验证Token,如果通过就返回数据,否则提示报错信息.</li></ol> <p>注意：前端是无设防的，不可以信任； 全部的校验都由后端完成</p> <p>我们这里是前后端一体的，当然选择<code>session+cookie</code>。这里有篇文章介绍还行，<a href="http://wiki.jikexueyuan.com/project/node-lessons/cookie-session.html" target="_blank" rel="noopener noreferrer">传送门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>我们这里登录需要实现2个，一个是本地登录，一个是第三方github登录。</p> <h3 id="本地登录"><a href="#本地登录" class="header-anchor">#</a> 本地登录</h3> <p><code>nestjs</code>已经帮我们封装好了<code>@nestjs/passport</code>，我们前面已经说了需要下载相关包。本地登录使用<code>passport-local</code>完成。</p> <p>新写个模板，需要去定义一个枚举ViewsPath 登录地址</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> authService<span class="token operator">:</span> AuthService<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
        <span class="token comment">/** 登录模板 */</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    @<span class="token function">Render</span><span class="token punctuation">(</span>ViewsPath<span class="token punctuation">.</span>Login<span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">loginView</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token operator">:</span> TRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> error<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">'loginError'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> pageTitle<span class="token operator">:</span> <span class="token string">'登录'</span><span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和正常注册模板控制器一样，这里多了一项<code>req.flash('loginError')[0]</code>，其实它是<code>connect-flash</code>中间件。其实我们自己写一个也完全没有问题，本身就没有几行代码，既然有轮子就用呗，它是做什么，就是帮我们去<code>session</code>记录消息，然后去获取，绑定在<code>Request</code>上。你需要安装它<code>npm install connect-flash -S</code>。</p> <p>模板直接拷贝<code>cnode</code>的登录模板，改了一下请求地址。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>     <span class="token comment">/** 本地登录提交 */</span>
    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">passportLocal</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token operator">:</span> TRequest<span class="token punctuation">,</span> @<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token operator">:</span> TResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verifyLogin</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/** 验证登录 */</span>
    <span class="token keyword">private</span> <span class="token function">verifyLogin</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span> @<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token punctuation">,</span> user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// id 存入 Cookie, 用于验证过期.</span>
        <span class="token keyword">const</span> auth_token <span class="token operator">=</span> user<span class="token punctuation">.</span>_id <span class="token operator">+</span> <span class="token string">'$$$$'</span><span class="token punctuation">;</span> <span class="token comment">// 以后可能会存储更多信息，用 $$$$ 来分隔</span>
        <span class="token comment">// 配置 Cookie</span>
        <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
            path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
            maxAge<span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
            signed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'AUTH_COOKIE_NAME'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> auth_token<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cookie 有效期30天</span>
        <span class="token comment">// 调用 passport 的 login方法 传递 user信息</span>
        req<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 重定向首页</span>
            res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里使用守卫，<code>AuthGuard</code>首页是<code>@nestjs/passport</code>。verifyLogin是登录以后操作。为什么封装一个方法，等下github登录成功也是一样的操作。<code>login</code>方法是<code>passport</code>的方法，<code>user</code>就是我们拿到的用户信息。</p> <p><strong>注意</strong>：这里的<code>passport-local</code>是网上的栗子实现有差别，网上栗子都可以配置，重定向的功能，</p> <p>这是<a href="http://www.passportjs.org/docs/authenticate/" target="_blank" rel="noopener noreferrer">passport<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文档里面的栗子。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> 
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">,</span> 
   <span class="token punctuation">{</span> 
       successRedirect<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
      failureRedirect<span class="token operator">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t
  <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个坑我也捣鼓很久，无论成功还是失败重定向都需要手动去处理它。成功就是上面我那个<code>login</code>。</p> <p>我们需要新增一个<code>passport</code>文件夹，里面放passport相关的业务。</p> <p>新建一个<code>local.strategy.ts</code>，处理<code>passport-local</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">,</span> <span class="token string">'local'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> authService<span class="token operator">:</span> AuthService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            usernameField<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
            passwordField<span class="token operator">:</span> <span class="token string">'pass'</span><span class="token punctuation">,</span>
            passReqToCallback<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// tslint:disable-next-line:ban-types</span>
    <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>user <span class="token operator">=&gt;</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里就比较简单，就这么几行代码，自定义一个本地策略，去继承<code>@nestjs/passport</code>一个父类，super需要传递是<code>new LocalStrategy('配置对象')</code>，<code>validate</code>是一个抽象方法，我们必须要去实现的，因为<code>@nestjs/passport</code>也不知道我们是怎么样查询用户是否存在，这个验证方法暴露给我们的去实现。<code>done</code>就相当于是<code>callback</code>，标准nodejs回调函数参数，第一个是表示错误，第二个是用户信息。</p> <p>放到<code>AuthModule</code>里面去做服务申明。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>SharedModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    AuthService<span class="token punctuation">,</span>
    AuthSerializer<span class="token punctuation">,</span>
    LocalStrategy<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthController<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>AuthSerializer也是和<code>passport</code>相关的，它里面需要实现2个方法<code>serializeUser</code>,<code>deserializeUser</code>。</p> <ul><li>serializeUser：将用户信息序列化后存进 session 里面，一般需要精简，只保存个别字段</li> <li>deserializeUser：反序列化后把用户信息从 session 中取出来，反查数据库拿到完整信息</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> PassportSerializer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthSerializer</span> <span class="token keyword">extends</span> <span class="token class-name">PassportSerializer</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 序列化用户
     * @param user
     * @param done
     */</span>
    <span class="token function">serializeUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token function-variable function">done</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 反序列化用户
     * @param payload
     * @param done
     */</span>
    <span class="token keyword">async</span> <span class="token function">deserializeUser</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token function-variable function">done</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们这里先简单粗暴把所有信息全部存到<code>session</code>，先实现功能，其他后面再优化。</p> <p>接下来去服务实现<code>local</code>方法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Validation methods</span>
<span class="token keyword">const</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">async</span> <span class="token function">local</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理用户名和密码前后空格，用户名全部小写 保证和注册一致</span>
        username <span class="token operator">=</span> username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        password <span class="token operator">=</span> password<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 验证用户名</span>
        <span class="token comment">// 可以用户名登录 /^[a-zA-Z0-9\-_]\w{4,20}$/</span>
        <span class="token comment">// 可以邮箱登录 标准邮箱格式</span>
        <span class="token comment">// 做一个验证用户名适配器</span>
        <span class="token keyword">const</span> <span class="token function-variable function">verifyUsername</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果输入账号里面有@，表示是邮箱</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> validator<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z0-9\-_]\w{4,20}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">verifyUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'用户名格式不正确。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 验证密码 密码长度是6-18位</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validator<span class="token punctuation">.</span><span class="token function">isByteLength</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'密码长度不是6-18位。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 做一个获取用户适配器</span>
        <span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果输入账号里面有@，表示是邮箱</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">getUserByMail</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">getUserByLoginName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查用户是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'用户不存在。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> equal <span class="token operator">=</span> <span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 密码不匹配</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>equal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'用户密码不匹配。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 用户未激活</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发送激活邮件</span>
            <span class="token keyword">const</span> token <span class="token operator">=</span> utility<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email <span class="token operator">+</span> user<span class="token punctuation">.</span>pass <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'SESSION_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mailService<span class="token punctuation">.</span><span class="token function">sendActiveMail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email<span class="token punctuation">,</span> token<span class="token punctuation">,</span> user<span class="token punctuation">.</span>loginname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'此帐号还没有被激活，激活链接已发送到 '</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>email <span class="token operator">+</span> <span class="token string">' 邮箱，请查收。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 验证通过</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面都有注释，这里说明一下为什么需要在这里去验证字段信息，这也是使用<code>@nestjs/passport</code>坑。</p> <p>验证使用<code>class-validator</code>提供的验证器类<code>Validator</code>，其他验证方法和我们注册保持一致。注释都已经一一说明。</p> <p>错误都使用<code>throw new UnauthorizedException('错误信息');</code>这样的方式去抛出，这也是在<code>AuthGuard</code>源码里面，有个处理请求方法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">handleRequest</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token operator">:</span> TUser <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> <span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>只要有错误，就回去走错误，这个错误就被<code>ExceptionFilter</code>捕获，我们有自定义的<code>HttpExceptionFilter</code>，等下就来讲它。
只有没有错误，成功才会返回user，这时候去走，<code>serializeUser</code>, <code>deserializeUser</code>, <code>passportLocal</code>最后重定向到首页。</p> <p><strong>注意</strong>：抛出异常一定要用<code>throw</code>，不用使用<code>return</code>。用<code>return</code>就直接走<code>serializeUser</code>，然后报错了。</p> <p>错误处理，因为这个身份认证只要出错返回都是401，那么我们需要去捕获处理一下，</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
            <span class="token keyword">case</span> HttpStatus<span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token operator">:</span> <span class="token comment">// 如果错误码 401</span>
                request<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">'loginError'</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span>message<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token string">'信息不全。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token operator">...</span>
</code></pre></div><p>默认<code>handleRequest</code>返回是一个空的，<code>exception.message.message</code>是<code>undefined</code>，这是<code>passport</code>返回，只要用户名或者密码没有填，都会返回这个错误信息，对应我们来捕获错误也是一脸懵逼，我看<code>cndoe</code>是直接返回<code>信息不全。</code>，这里就一样简单粗暴处理了。</p> <blockquote><p>说多了都是眼泪，这个地方卡了我很久。这篇文章卡壳，它需要付50%责任，因为网上没有关于<code>@nestjs/passport</code>的<code>passport-local</code>的栗子。大多数都是<code>jwt</code>栗子，比较折腾，试过各种方法方式。</p></blockquote> <h3 id="github登录"><a href="#github登录" class="header-anchor">#</a> github登录</h3> <p>这个玩意就本地登录简单多了。先说下流程：</p> <p>我们网站叫<code>nest-cnode</code></p> <ol><li>nest-cnode 网站让用户跳转到 GitHub。</li> <li>GitHub 要求用户登录，然后询问&quot;nest-cnode 网站要求获得 xx 权限，你是否同意？&quot;</li> <li>用户同意，GitHub 就会重定向回 nest-cnode 网站，同时发回一个授权码。</li> <li>nest-cnode 网站使用授权码，向 GitHub 请求令牌。</li> <li>GitHub 返回令牌.</li> <li>nest-cnode 网站使用令牌，向 GitHub 请求用户数据。</li></ol> <p>接下来我们就去实现一下：</p> <p>先github申请一个认证，应用登记。</p> <p>一个应用要求 OAuth 授权，必须先到对方网站登记，让对方知道是谁在请求。</p> <p>所以，我们要先去 GitHub 登记一下。这是免费的。</p> <p>访问这个<a href="https://github.com/settings/applications/new" target="_blank" rel="noopener noreferrer">网址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，填写登记表。</p> <p><a href="https://user-images.githubusercontent.com/6111778/56720050-78ad4780-6774-11e9-8503-e494f8bc79b9.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/56720050-78ad4780-6774-11e9-8503-e494f8bc79b9.png" alt="%V}9$D4LD_4YLFKXRTVJ7QP"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>应用的名称随便填，主页 URL 填写<code>http://localhost:3000</code>，跳转网址填写 <code>http://localhost:3000/github/callback</code>。</p> <p>提交表单以后，GitHub 应该会返回客户端 ID（client ID）和客户端密钥（client secret），这就是应用的身份识别码。</p> <p>我们创建一个<code>github.strategy.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GithubStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> config<span class="token operator">:</span> ConfigService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            clientID<span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'GITHUB_CLIENT_ID'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            clientSecret<span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'GITHUB_CLIENT_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            callbackURL<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'HOST'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'PORT'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/github/callback</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// tslint:disable-next-line:ban-types</span>
    <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> profile<span class="token operator">:</span> GitHubProfile<span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        profile<span class="token punctuation">.</span>accessToken <span class="token operator">=</span> accessToken<span class="token punctuation">;</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要配置<code>clientID</code>, <code>clientSecret</code>, <code>callbackURL</code>, 这3个东西，我们上面图里面都有。把它申明到模块里面去。</p> <p>github2个必备的路由：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>    <span class="token comment">/** github登录提交 */</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/github'</span><span class="token punctuation">)</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'github'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">github</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/github/callback'</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">githubCallback</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token operator">:</span> TRequest<span class="token punctuation">,</span> @<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token operator">:</span> TResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> existUser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">github</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verifyLogin</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> existUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>我们需要github登录时候就去请求<code>/github</code>路由，使用守卫，告诉守卫使用<code>github</code>策略。这个方法随便写，返回都会重定向到<a href="https://github.com/" target="_blank" rel="noopener noreferrer">github.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，填完登录信息，就会自动跳转到<code>githubCallback</code>方法里面，<code>req.user</code>返回就是github给我们提供的所有信息。我们需要去和我们用户系统做关联。</p> <p>服务github方法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token function">github</span><span class="token punctuation">(</span>profile<span class="token operator">:</span> GitHubProfile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>profile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'您 GitHub 账号的 认证失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取用户的邮箱</span>
        <span class="token keyword">const</span> email <span class="token operator">=</span> profile<span class="token punctuation">.</span>emails <span class="token operator">&amp;&amp;</span> profile<span class="token punctuation">.</span>emails<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> profile<span class="token punctuation">.</span>emails<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token comment">// 根据 githubId 查找用户</span>
        <span class="token keyword">let</span> existUser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">getUserByGithubId</span><span class="token punctuation">(</span>profile<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 用户不存在则创建</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>existUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            existUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            existUser<span class="token punctuation">.</span>githubId <span class="token operator">=</span> profile<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
            existUser<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            existUser<span class="token punctuation">.</span>accessToken <span class="token operator">=</span> profile<span class="token punctuation">.</span>accessToken<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 用户存在，更新字段</span>
        existUser<span class="token punctuation">.</span>loginname <span class="token operator">=</span> profile<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
        existUser<span class="token punctuation">.</span>email <span class="token operator">=</span> email <span class="token operator">||</span> existUser<span class="token punctuation">.</span>email<span class="token punctuation">;</span>
        existUser<span class="token punctuation">.</span>avatar <span class="token operator">=</span> profile<span class="token punctuation">.</span>_json<span class="token punctuation">.</span>avatar_url<span class="token punctuation">;</span>
        existUser<span class="token punctuation">.</span>githubUsername <span class="token operator">=</span> profile<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
        existUser<span class="token punctuation">.</span>githubAccessToken <span class="token operator">=</span> profile<span class="token punctuation">.</span>accessToken<span class="token punctuation">;</span>

        <span class="token comment">// 保存用户到数据库</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> existUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回用户</span>
            <span class="token keyword">return</span> existUser<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取MongoError错误信息</span>
            <span class="token keyword">const</span> errmsg <span class="token operator">=</span> error<span class="token punctuation">.</span>errmsg <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理邮箱和用户名重复问题</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errmsg<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'duplicate key error'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errmsg<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'您 GitHub 账号的 Email 与之前在 CNodejs 注册的 Email 重复了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>errmsg<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'loginname'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">'您 GitHub 账号的用户名与之前在 CNodejs 注册的用户名重复了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalServerErrorException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>注意</strong>：<code>profile</code>返回信息可能是个<code>undefined</code>，因为认证可能会失败，需要去处理一下，不然后面代码全挂了。O(∩_∩)O哈哈~。</p> <p>登录功能基本完成了，需要判断用户登录。</p> <p>我们需要写一个中间件，<code>current_user.middleware.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> NestMiddleware<span class="token punctuation">,</span> MiddlewareFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CurrentUserMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">NestMiddleware</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> MiddlewareFunction <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>current_user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>current_user <span class="token operator">=</span> user<span class="token punctuation">;</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为<code>passport</code>登录成功以后，会自动给<code>req</code>添加一个属性<code>user</code>，我们只需要去判断它就可以了。</p> <p><strong>注意</strong>：<code>nestjs</code>中间件和<code>express</code>中间件有区别：</p> <p>express定义的中间件，如果全局可以直接通过<code>express.use(中间件)</code>去申明使用。</p> <p>nestjs定义的中间件不能这么玩，需要在模块里面去申明使用。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token operator">:</span> MiddlewareConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">consumer</span>
      <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>CurrentUserMiddleware<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">forRoutes</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> method<span class="token operator">:</span> RequestMethod<span class="token punctuation">.</span><span class="token constant">ALL</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们把全局的中间件都丢到<code>AppModule</code>，里面去申明使用。</p> <p>修改一下<code>AppController</code>首页：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span>
  <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>登录前：</p> <p><a href="https://user-images.githubusercontent.com/6111778/56723079-dc3a7380-677a-11e9-8429-d562ae754c3c.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/56723079-dc3a7380-677a-11e9-8429-d562ae754c3c.png" alt="KZWPT O)_GKL`$6 RAISBOX"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>登录后：</p> <p><a href="https://user-images.githubusercontent.com/6111778/56723112-eb212600-677a-11e9-82da-c7a0b24700ec.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/6111778/56723112-eb212600-677a-11e9-82da-c7a0b24700ec.png" alt="0SJTB2VL`C)C7P6F34KT6V5"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在弄个退出就完美了：它就更简单了:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
    <span class="token comment">/** 登出 */</span>
    @<span class="token function">All</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">logout</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token operator">:</span> TRequest<span class="token punctuation">,</span> @<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token operator">:</span> TResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 销毁 session</span>
        req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 清除 cookie</span>
        res<span class="token punctuation">.</span><span class="token function">clearCookie</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'AUTH_COOKIE_NAME'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用 passport 的 logout方法</span>
        req<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重定向到首页</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就是一波清空操作，调用<code>passport</code>的<code>logout</code>方法。</p> <p>代码已更新，<a href="https://github.com/jiayisheji/nest-cnode" target="_blank" rel="noopener noreferrer">传送门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>欲知后事如何，请听下回分解。</p> <blockquote><p>中篇就到此为止了，最后感谢大家暴力吹更，让我坚持不懈的把它写完。后面就比较容易了。<a href="https://github.com/typeorm/typeorm" target="_blank" rel="noopener noreferrer">Typeorm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>比较火，等我把全部业面写完了，会更新<code>typeorm</code>版操作<code>MongoDB</code>。回馈大家不离不弃的关注，再次感谢大家阅读。</p></blockquote> <p><a href="https://github.com/jiayisheji/blog/issues/18" target="_blank" rel="noopener noreferrer">本文来自 https://github.com/jiayisheji/blog/issues/19<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/31/2021, 8:20:29 PM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div></div><div id="goTop" class="hide-cat" data-v-bf92849a></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      我是blackCat欢迎你的关注 
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="160" height="272" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><APlayer audio="" fixed="true" autoplay="autoplay" theme="#b7daff" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="0" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.4aa0e8ea.js" defer></script><script src="/assets/js/4.3a6b897f.js" defer></script><script src="/assets/js/1.97f2804a.js" defer></script><script src="/assets/js/2.13201674.js" defer></script><script src="/assets/js/42.5ae1c9f5.js" defer></script>
  </body>
</html>
